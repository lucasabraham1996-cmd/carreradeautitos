<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÅ Carrera de Autitos Digital</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons (√çconos) -->
    <script type="module">
        import { createIcons, icons } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.esm.js';
        createIcons({ icons });
    </script>
    <style>
        /* Importar fuente Poppins */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@100;400;700;900&display=swap');
        
        /* Aplicar a todos los elementos */
        body, .font-poppins {
          font-family: 'Poppins', sans-serif;
        }

        /* Estilo para el input[type=color] para que sea est√©tico */
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 0.5rem; /* rounded-lg */
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
        }
        
        /* Estilo base para el efecto glassmorphism */
        .glass-card {
            backdrop-filter: blur(12px);
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Ocultar flechas de n√∫mero en inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { 
            -moz-appearance: textfield;
        }

    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 bg-gray-900 font-poppins relative">

    <!-- Fondo -->
    <div class="fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 opacity-95"></div>
    <div class="fixed inset-0 bg-repeat opacity-[0.05]" style="background-image: url('data:image/svg+xml;utf8,<svg width=\"10\" height=\"10\" viewBox=\"0 0 10 10\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"5\" cy=\"5\" r=\"1\" fill=\"%23FFFFFF\"/></svg>'); background-size: 20px 20px;"></div>
    
    <!-- Contenido principal -->
    <div class="relative max-w-7xl mx-auto z-10">
        
        <!-- Encabezado Principal (Glass Card) -->
        <div class="glass-card p-4 sm:p-6 mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 drop-shadow-lg">
              üèÅ Carrera de Autitos Digital
            </h1>
            <p class="text-gray-300 mt-1">
                ¬°Una pista moderna para jugar con tu nene! | 
                <span id="user-id-display" class="font-mono text-xs bg-gray-700/50 p-1 rounded ml-2">Cargando...</span>
            </p>
        </div>

        <!-- Barra de Pesta√±as -->
        <div id="tabs-container" class="flex space-x-1 sm:space-x-4 border-b border-white/20 overflow-x-auto whitespace-nowrap">
            <!-- Los botones de las pesta√±as se generan aqu√≠ -->
        </div>

        <!-- Contenido de la Pesta√±a -->
        <div id="tab-content" class="glass-card mt-0 pt-4 pb-8 bg-gray-800/20" style="min-height: 60vh;">
            <div id="loading-indicator" class="p-8 text-center text-white text-xl font-poppins">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-400 border-t-transparent rounded-full mb-4"></div>
                <p>Cargando datos y autenticaci√≥n...</p>
            </div>
        </div>
    </div>

    <!-- Scripts de Firebase y L√≥gica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTES Y UTILIDADES DE FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // Datos de la aplicaci√≥n
        let cars = []; // Autos de usuario
        let genericCars = [
            { id: 'gen-1', brand: 'Ferrari', model: 'F40', color: '#ef4444', logo: 'üêé', isGeneric: true },
            { id: 'gen-2', brand: 'Mercedes', model: 'AMG', color: '#6b7280', logo: 'üåü', isGeneric: true },
            { id: 'gen-3', brand: 'Red Bull', model: 'RB19', color: '#2563eb', logo: 'üêÇ', isGeneric: true },
            { id: 'gen-4', brand: 'McLaren', model: 'F1', color: '#f97316', logo: 'ü•ù', isGeneric: true },
            { id: 'gen-5', brand: 'Aston Martin', model: 'Valkyrie', color: '#059669', logo: 'üåø', isGeneric: true },
            { id: 'gen-6', brand: 'Peugeot', model: '208', color: '#312e81', logo: 'ü¶Å', isGeneric: true },
            { id: 'gen-7', brand: 'Volkswagen', model: 'Golf', color: '#1d4ed8', logo: 'ü™≤', isGeneric: true },
            { id: 'gen-8', brand: 'FIAT', model: 'Cronos', color: '#dc2626', logo: 'üáÆüáπ', isGeneric: true },
            { id: 'gen-9', brand: 'Ford', model: 'Mustang', color: '#f59e0b', logo: 'üíô', isGeneric: true },
            { id: 'gen-10', brand: 'Renault', model: 'Clio', color: '#facc15', logo: 'üíé', isGeneric: true },
            { id: 'gen-11', brand: 'Audi', model: 'R8', color: '#4b5563', logo: '‚≠ï', isGeneric: true },
            { id: 'gen-12', brand: 'BMW', model: '911', color: '#8b5cf6', logo: 'üí†', isGeneric: true },
            { id: 'gen-13', brand: 'Chevrolet', model: 'GT', color: '#06b6d4', logo: 'üü¶', isGeneric: true },
            { id: 'gen-14', brand: 'Toyota', model: 'Corvette', color: '#1f2937', logo: 'üèéÔ∏è', isGeneric: true },
            { id: 'gen-15', brand: 'Nissan', model: 'Supra', color: '#9d174d', logo: 'üü•', isGeneric: true },
            { id: 'gen-16', brand: 'Alpine', model: 'A110', color: '#fb7185', logo: '‚õ∞Ô∏è', isGeneric: true },
        ].map(car => ({...car, isGeneric: true}));
        let cupData = { participants: [], rounds: [], winnerId: null };
        let timeRaceData = { results: [] };
        let streetCounterData = { counters: [], isCounting: false, winner: null, competitionMode: 'model' };

        let activeTab = 'garage';

        // Variables de cron√≥metro
        let stopwatchTime = 0;
        let stopwatchRunning = false;
        let stopwatchInterval = null;
        let recordedTime = null;

        // --- UTILIDADES ---

        const generateId = () => Math.random().toString(36).substring(2, 9);
        
        const getCarConfig = (carId) => {
            const all = getAllAvailableCars();
            const car = all.find(c => c.id === carId);
            if (!car) return { model: 'N/A', brand: 'N/A', logo: '?', color: '#4b5563' };
            return car;
        };

        const getModelInitials = (model) => {
            if (!model) return '??';
            if (model.split(/\s+|-/).length === 1) {
                return model.toUpperCase();
            }
            return model.split(/\s+|-/)
                .map(word => word.charAt(0))
                .join('')
                .toUpperCase();
        };

        const formatTime = (timeInMs) => {
            const totalSeconds = timeInMs / 1000;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const milliseconds = Math.floor((totalSeconds * 1000) % 1000);

            const pad = (num, length = 2) => String(num).padStart(length, '0');

            return `${pad(minutes)}:${pad(seconds)}.${pad(milliseconds, 3)}`;
        };

        const getAllAvailableCars = () => {
            const userCars = cars;
            const userCarIds = new Set(userCars.map(c => c.id));
            
            // Filtra gen√©ricos que NO han sido eliminados/reemplazados por el usuario
            const activeGenericCars = genericCars.filter(gCar => !userCarIds.has(gCar.id) && !userCars.some(uCar => uCar.id === gCar.id));
            
            return [...userCars, ...activeGenericCars];
        };

        // --- RENDERIZADO UI ---

        const renderApp = (tab = activeTab) => {
            if (!isAuthReady) return;

            const content = document.getElementById('tab-content');
            
            // Renderizar la barra de pesta√±as
            const tabsContainer = document.getElementById('tabs-container');
            tabsContainer.innerHTML = [
                { id: 'garage', icon: 'car', label: 'Garaje (Autos)' },
                { id: 'cup', icon: 'award', label: 'Copa Eliminatoria' },
                { id: 'timerace', icon: 'clock', label: 'Carrera de Tiempos (F1)' },
                { id: 'streetcounter', icon: 'users', label: 'Contador Calle' }
            ].map(t => `
                <button
                    onclick="setTab('${t.id}')"
                    class="px-4 py-3 flex items-center space-x-2 rounded-t-xl transition-all duration-300 font-poppins
                    ${tab === t.id ? 'bg-white/20 border-b-4 border-blue-400 text-blue-300 font-bold shadow-xl shadow-blue-500/30' : 'text-gray-300 hover:bg-white/10 hover:text-white'}
                    backdrop-blur-sm"
                >
                    <i data-lucide="${t.icon}" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">${t.label}</span>
                </button>
            `).join('');

            // Renderizar contenido de la pesta√±a
            content.innerHTML = `<div class="p-6 space-y-8">${getTabContent(tab)}</div>`;
            activeTab = tab;
            
            // Inicializar iconos de Lucide Icons en el contenido
            setTimeout(() => {
                const { createIcons, icons } = window.lucide;
                if (createIcons) createIcons({ icons });
            }, 0);

            // Re-adjuntar listeners si es necesario (manejo manual de eventos)
            attachEventListeners();
        };
        
        // Placeholder simple para el logo (usado en Garaje, Carrera, Copa y Contador)
        const renderLogoDisplay = (logo, model, size = 'w-6 h-6', isWatermark = false, color = '#ffffff') => {
            const isURL = logo && logo.startsWith('http');
            const watermarkStyle = isWatermark ? `transform: translateY(-50%) rotate(-15deg); color: ${color}; opacity: 0.15;` : '';
            const watermarkClass = isWatermark ? 'absolute -left-4 top-1/2' : '';
            const imgStyle = isWatermark ? 'filter: grayscale(100%) brightness(150%);' : '';

            if (isURL) {
                const sizePx = isWatermark ? '128px' : '28px';
                return `
                    <img src="${logo}" alt="Logo de ${model}" 
                         class="object-contain ${isWatermark ? 'w-32 h-32' : size} ${isWatermark ? 'rounded-none' : 'rounded-full'} ${watermarkClass}" 
                         style="${isWatermark ? `width: ${sizePx}; height: ${sizePx};` : ''} ${imgStyle}"
                         onerror="this.onerror=null;this.src='https://placehold.co/24x24/1f2937/f9fafb?text=L';"
                    >
                `;
            } else {
                 const fontSize = isWatermark ? '5rem' : '1.25rem';
                 return `
                    <span class="${isWatermark ? 'text-[6rem] opacity-70' : ''} flex items-center justify-center ${size} ${watermarkClass}" style="${watermarkStyle}; font-size: ${fontSize};">
                        ${logo || 'üöó'}
                    </span>
                 `;
            }
        };


        // --- CONTENIDO DE PESTA√ëAS ---

        const getTabContent = (tab) => {
            if (!isAuthReady) return `<div class="p-8 text-center text-white text-xl font-poppins"><i data-lucide="loader" class="w-8 h-8 animate-spin inline-block mb-4"></i><p>Cargando datos y autenticaci√≥n...</p></div>`;

            switch (tab) {
                case 'garage': return renderGarageTab();
                case 'cup': return renderCupTab();
                case 'timerace': return renderTimeRaceTab();
                case 'streetcounter': return renderStreetCounterTab();
                default: return '';
            }
        };
        
        // --- GARAGE TAB ---

        const renderGarageTab = () => {
            const defaultNewCarState = { id: '', brand: '', model: '', color: '#3b82f6', logo: 'üöó', isGeneric: false };
            const currentCar = window.newCar || defaultNewCarState;
            const isEditing = !!currentCar.id;
            const allCars = getAllAvailableCars();
            
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                window.newCar = { ...currentCar, [name]: value };
                // Actualiza solo los inputs para no re-renderizar todo
                document.getElementById(name + 'Input').value = value; 
                if (name === 'color') document.getElementById('colorPicker').value = value;
                if (name === 'color') document.getElementById('colorHex').value = value;
                if (name === 'logo') document.getElementById('logoDisplayPreview').innerHTML = renderLogoDisplay(value, currentCar.model, 'w-7 h-7');
            };

            // HTML del formulario
            const formHtml = `
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                        <i data-lucide="car" class="w-6 h-6 mr-2 text-blue-400"></i>
                        ${isEditing ? 'Editar Auto Existente' : 'Nuevo Auto al Garaje'}
                    </h2>
                    
                    <p id="garage-error" class="mb-4 p-2 rounded-lg text-white" style="display: none;"></p>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        
                        <div>
                            <label for="brandInput" class="block text-sm font-medium text-gray-300 mb-1">Marca</label>
                            <input type="text" name="brand" id="brandInput" value="${currentCar.brand}" placeholder="Ej: Lamborghini, FIAT"
                                oninput="window.newCar = {...window.newCar, brand: this.value};"
                                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:ring-blue-400 focus:border-blue-400 transition-colors"
                            />
                        </div>
                        
                        <div>
                            <label for="modelInput" class="block text-sm font-medium text-gray-300 mb-1">Modelo</label>
                            <input type="text" name="model" id="modelInput" value="${currentCar.model}" placeholder="Ej: Diablo, Cronos"
                                oninput="window.newCar = {...window.newCar, model: this.value};"
                                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:ring-blue-400 focus:border-blue-400 transition-colors"
                            />
                        </div>

                        <div class="relative md:col-span-2 flex space-x-4">
                            <div class="flex-1">
                                <label for="colorPicker" class="block text-sm font-medium text-gray-300 mb-1">Color Base</label>
                                <input type="color" name="color" id="colorPicker" value="${currentCar.color}"
                                    oninput="document.getElementById('colorHex').value = this.value; window.newCar = {...window.newCar, color: this.value};"
                                    class="w-full h-[42px] bg-white/20 border border-white/30 rounded-lg focus:ring-blue-400 focus:border-blue-400 transition-colors cursor-pointer" style="padding: 0; border: none;"
                                />
                            </div>
                            <div class="flex-1">
                                <label for="colorHex" class="block text-sm font-medium text-gray-300 mb-1">Hex</label>
                                <input type="text" name="color" id="colorHex" value="${currentCar.color}" placeholder="#3b82f6"
                                    oninput="document.getElementById('colorPicker').value = this.value; window.newCar = {...window.newCar, color: this.value};"
                                    class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:ring-blue-400 focus:border-blue-400 transition-colors"
                                />
                            </div>
                        </div>
                        
                        <div class="md:col-span-4">
                            <label for="logoInput" class="block text-sm font-medium text-gray-300 mb-1">Logo (Emoji o URL)</label>
                            <div class="flex space-x-2">
                                <input type="text" name="logo" id="logoInput" value="${currentCar.logo}" placeholder="Ej: üèéÔ∏è o https://logo.com/image.png"
                                    oninput="document.getElementById('logoDisplayPreview').innerHTML = renderLogoDisplay(this.value, 'Preview', 'w-7 h-7'); window.newCar = {...window.newCar, logo: this.value};"
                                    class="flex-1 px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:ring-blue-400 focus:border-blue-400 transition-colors"
                                />
                                <div id="logoDisplayPreview" class="w-10 h-[42px] flex items-center justify-center bg-white/20 rounded-lg overflow-hidden">
                                    ${renderLogoDisplay(currentCar.logo, currentCar.model, 'w-7 h-7')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end space-x-2">
                        ${isEditing ? `
                            <button onclick="setNewCarState(null)" class="px-4 py-2 rounded-xl text-white font-semibold transition-all duration-200 bg-gray-600 hover:bg-gray-700 shadow-lg shadow-gray-500/50">
                                Cancelar Edici√≥n
                            </button>
                        ` : ''}
                        <button onclick="handleSaveCarClick()" class="px-4 py-2 rounded-xl text-white font-semibold transition-all duration-200 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 shadow-lg shadow-blue-500/50" id="save-car-button">
                            ${isEditing ? 'Guardar Cambios' : 'A√±adir Auto'}
                        </button>
                    </div>
                </div>
            `;

            // HTML de la lista de autos
            const listHtml = `
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-white mb-4">Visualizador de Autos Cargados (${allCars.length})</h2>
                    <p class="text-gray-400 mb-4 text-sm">Los autos gen√©ricos (Gen√©rico) pueden ser **eliminados** para ser reemplazados por tus propios autos. **Presiona el l√°piz para editar o precargar datos.**</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-h-96 overflow-y-auto pr-2">
                        ${allCars.length === 0 ? '<p class="text-gray-400 col-span-full">No hay autos disponibles.</p>' : allCars.map(car => `
                            <div class="glass-card bg-gray-900/50 p-3 flex items-center justify-between space-x-3 w-full">
                                <div class="flex items-center space-x-3 flex-1 rounded-lg p-2 font-poppins shadow-inner border-2"
                                    style="background-color: ${car.color}; border-color: ${car.color === '#f9fafb' ? '#d1d5db' : '#ffffff40'}; box-shadow: 0 0 10px ${car.color}50;">
                                    <div class="w-8 h-8 flex-shrink-0 bg-white/30 rounded-full flex items-center justify-center overflow-hidden">
                                        ${renderLogoDisplay(car.logo, car.model, 'w-7 h-7')}
                                    </div>
                                    <div class="text-white font-bold truncate text-sm">
                                        <span class="text-xs block opacity-70">${car.brand} ${car.isGeneric ? '(Gen√©rico)' : ''}</span>
                                        <span class="text-lg block font-extrabold leading-none">${car.model}</span>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button onclick="handleEditCarClick('${car.id}')" class="p-1 rounded-full text-blue-400 hover:bg-blue-500/20 transition-colors flex-shrink-0">
                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="handleDeleteCarClick('${car.id}', ${car.isGeneric})" class="p-1 rounded-full text-red-400 hover:bg-red-500/20 transition-colors flex-shrink-0">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            window.newCar = currentCar; // Asegurar que el estado del formulario se mantenga globalmente
            return formHtml + listHtml;
        };

        // --- FUNCIONES DE MANEJO DE EVENTOS DE GARAGE (GLOBALES) ---

        window.setNewCarState = (car = null) => {
            window.newCar = car ? { ...car, isGeneric: false } : { id: '', brand: '', model: '', color: '#3b82f6', logo: 'üöó' };
            renderApp('garage');
        };

        window.handleEditCarClick = (carId) => {
            const car = getAllAvailableCars().find(c => c.id === carId);
            if (car) {
                window.newCar = { 
                    id: car.id, 
                    brand: car.brand, 
                    model: car.model, 
                    color: car.color, 
                    logo: car.logo,
                    isGeneric: car.isGeneric
                };
                if (car.isGeneric) {
                     window.showError("garage", "Este es un auto gen√©rico. Presiona 'Guardar Cambios' para crear una copia editable.");
                } else {
                     window.showError("garage", null);
                }
                renderApp('garage');
            }
        };

        window.handleSaveCarClick = async () => {
            // L√≥gica de validaci√≥n
            const currentCar = window.newCar;
            if (!currentCar.model.trim() || !currentCar.brand.trim()) {
                window.showError("garage", "La Marca y el Modelo del auto no pueden estar vac√≠os.", 'bg-red-800/50');
                return;
            }

            // Deshabilitar bot√≥n
            document.getElementById('save-car-button').innerHTML = 'Guardando...';
            document.getElementById('save-car-button').disabled = true;

            const carData = {
                ...currentCar,
                brand: currentCar.brand.trim(),
                model: currentCar.model.trim(),
                isGeneric: false 
            };
            
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/cars`, 'user_cars_list');
                const docSnap = await getDoc(userDocRef);
                const currentList = docSnap.exists() ? docSnap.data().list || [] : [];
                
                let updatedList = [...currentList];

                if (currentCar.id) {
                    const index = updatedList.findIndex(c => c.id === currentCar.id);
                    if (index !== -1) {
                        updatedList[index] = carData; // Actualizar auto existente (no gen√©rico)
                    } else {
                        // Edici√≥n de Gen√©rico o auto no persistido (se a√±ade como nuevo)
                        carData.id = generateId();
                        updatedList.push(carData);
                    }
                } else {
                    // Nuevo auto
                    carData.id = generateId();
                    updatedList.push(carData);
                }
                
                // Sobrescribir la lista completa de autos de usuario en Firestore
                await setDoc(userDocRef, { list: updatedList });
                window.showError("garage", "Auto guardado con √©xito.", 'bg-green-800/50');

                // Si fue una edici√≥n de un gen√©rico, necesitamos hacer una eliminaci√≥n local
                if (currentCar.isGeneric) {
                    // Si guardamos un auto basado en un gen√©rico, el gen√©rico deber√≠a "desaparecer"
                    // de la vista local (se maneja por el App.js al no tener su ID en 'cars')
                }

                setNewCarState(null); // Resetear formulario

            } catch (e) {
                console.error("Error al guardar/editar auto: ", e);
                window.showError("garage", "Fallo al guardar/editar el auto.", 'bg-red-800/50');
            } finally {
                document.getElementById('save-car-button').innerHTML = currentCar.id ? 'Guardar Cambios' : 'A√±adir Auto';
                document.getElementById('save-car-button').disabled = false;
            }
        };

        window.handleDeleteCarClick = async (carId, isGeneric) => {
            if (!auth.currentUser || !db) return;

            if (isGeneric) {
                // L√ìGICA DE ELIMINACI√ìN FORZADA DE GEN√âRICO: 
                // Al eliminar un gen√©rico (que no est√° en Firestore), simplemente 
                // forzamos la actualizaci√≥n del estado 'cars' en el App.js para que 
                // se filtre fuera de 'allAvailableCars' inmediatamente en la sesi√≥n.
                
                // Nota: Usamos una mutaci√≥n temporal de la lista para forzar la re-renderizaci√≥n local
                const updatedCars = cars.filter(c => c.id !== carId);
                cars = updatedCars;
                window.setNewCarState(null); // Forzar re-renderizado
                window.showError("garage", "Auto gen√©rico eliminado de la lista de participantes.", 'bg-orange-800/50');
                
            } else {
                // ELIMINACI√ìN DE AUTO DE USUARIO (PERSISTENTE EN FIRESTORE)
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/cars`, 'user_cars_list');
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const currentList = docSnap.data().list || [];
                        const newList = currentList.filter(c => c.id !== carId);
                        await setDoc(userDocRef, { list: newList });
                        window.showError("garage", "Auto de usuario eliminado permanentemente.", 'bg-green-800/50');
                    }
                    if (window.newCar && window.newCar.id === carId) {
                        setNewCarState(null);
                    }
                } catch (e) {
                    console.error("Error al eliminar auto de usuario: ", e);
                    window.showError("garage", "Fallo al eliminar el auto de usuario.", 'bg-red-800/50');
                }
            }
            renderApp('garage');
        };
        
        // Funci√≥n auxiliar para mostrar errores
        window.showError = (tabId, message, colorClass = 'bg-red-800/50') => {
            const container = document.getElementById(tabId + '-error');
            if (container) {
                if (message) {
                    container.innerHTML = message;
                    container.className = `mb-4 p-2 rounded-lg text-white ${colorClass}`;
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                    container.innerHTML = '';
                }
            }
        };

        // --- Resto de funciones (Copa, Carrera, Contador) ---
        
        // [Implementaci√≥n simplificada para el demo, enfoc√°ndose en la est√©tica y bugs]
        
        const renderCupTab = () => {
            const MAX_PARTICIPANTS = 16;
            const participantsToUse = getAllAvailableCars().slice(0, MAX_PARTICIPANTS);
            const isCupReady = participantsToUse.length === MAX_PARTICIPANTS;
            const isCupStarted = cupData.rounds.length > 0;

            const handleInitCup = async () => {
                 if (participantsToUse.length < MAX_PARTICIPANTS) return;
                
                const shuffledCars = [...participantsToUse].sort(() => 0.5 - Math.random());
                const newRounds = [{ name: 'Octavos', matches: [] }, { name: 'Cuartos', matches: [] }, { name: 'Semifinales', matches: [] }, { name: 'Final', matches: [] }];
                for (let i = 0; i < MAX_PARTICIPANTS / 2; i++) {
                    newRounds[0].matches.push({ id: generateId(), car1Id: shuffledCars[i * 2].id, car2Id: shuffledCars[i * 2 + 1].id, winnerId: null });
                }
                cupData = { participants: shuffledCars.map(c => c.id), rounds: newRounds, winnerId: null };
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/cup`, 'cup_state'), cupData);
                renderApp('cup');
            };

            const handleSelectWinner = async (roundIndex, matchIndex, winnerCarId) => {
                const newCupData = JSON.parse(JSON.stringify(cupData));
                const currentMatch = newCupData.rounds[roundIndex].matches[matchIndex];
                currentMatch.winnerId = winnerCarId;
                
                if (roundIndex < 3) {
                    const nextRoundIndex = roundIndex + 1;
                    const nextMatchIndex = Math.floor(matchIndex / 2);
                    
                    if (!newCupData.rounds[nextRoundIndex].matches[nextMatchIndex]) {
                        newCupData.rounds[nextRoundIndex].matches[nextMatchIndex] = { id: generateId(), car1Id: null, car2Id: null, winnerId: null };
                    }
                    
                    const nextMatch = newCupData.rounds[nextRoundIndex].matches[nextMatchIndex];
                    if (matchIndex % 2 === 0) { nextMatch.car1Id = winnerCarId; } else { nextMatch.car2Id = winnerCarId; }
                    if (!nextMatch.car1Id || !nextMatch.car2Id) { nextMatch.winnerId = null; }

                } else {
                    newCupData.winnerId = winnerCarId;
                }

                cupData = newCupData;
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/cup`, 'cup_state'), cupData);
                renderApp('cup');
            };

            const renderCarBox = (carId, match, roundIndex, matchIndex) => {
                const config = getCarConfig(carId);
                const isWinner = match.winnerId === carId;
                const isMatchComplete = match.car1Id && match.car2Id;
                const bgColor = config.color;

                const glassStyle = `background-image: linear-gradient(to right, ${bgColor}D0, #ffffff30, ${bgColor}D0); background-color: ${isWinner ? `${bgColor}AA` : 'rgba(255, 255, 255, 0.1)'}; border-color: ${isWinner ? `${bgColor}` : 'rgba(255, 255, 255, 0.3)'};`;
                const cursorClass = isMatchComplete ? 'cursor-pointer hover:scale-[1.03] active:scale-[0.98]' : 'cursor-default';

                return `
                    <div 
                        onclick="${isMatchComplete ? `handleSelectWinner(${roundIndex}, ${matchIndex}, '${carId}')` : ''}"
                        class="relative p-2 rounded-xl h-12 flex items-center justify-between overflow-hidden font-bold text-white transition-all duration-300 border shadow-md ${cursorClass} ${match.winnerId && match.winnerId !== carId ? 'opacity-50' : ''}"
                        style="${glassStyle}"
                    >
                        ${renderLogoDisplay(config.logo, config.model, 'w-24 h-24', true, bgColor)}
                        
                        <div class="z-10 flex items-center space-x-2">
                            <div class="w-6 h-6 flex items-center justify-center p-1 rounded-full bg-white/30">
                                ${renderLogoDisplay(config.logo, config.model, 'w-5 h-5')}
                            </div>
                            <span class="text-sm truncate font-extrabold">${getModelInitials(config.model)}</span>
                        </div>
                        
                        ${isWinner ? `<i data-lucide="trophy" class="w-5 h-5 z-10 text-white"></i>` : ''}
                    </div>
                `;
            };

            window.handleSelectWinner = handleSelectWinner;
            window.handleInitCup = handleInitCup;

            if (!isCupReady) {
                return `<div class="glass-card p-6 text-center text-gray-400">Se requieren ${MAX_PARTICIPANTS} autos (actual: ${participantsToUse.length}) para iniciar la Copa.</div>`;
            }

            if (!isCupStarted) {
                return `<div class="glass-card p-6 text-center"><p class="text-white mb-4">Presiona el bot√≥n para generar el sorteo inicial.</p><button onclick="handleInitCup()" class="px-4 py-2 rounded-xl text-white font-semibold bg-green-600 hover:bg-green-700 shadow-lg shadow-green-500/50">Iniciar Copa</button></div>`;
            }

            const cupRoundsHtml = cupData.rounds.map((round, rIndex) => `
                <div class="flex flex-col space-y-4">
                    <h3 class="text-lg font-semibold text-gray-200 mb-2 text-center border-b border-white/20 pb-1">${round.name}</h3>
                    <div class="space-y-${rIndex < 3 ? '12' : '4'}" style="padding-top: ${rIndex * 2}rem;">
                        ${round.matches.map((match, mIndex) => `
                            <div class="space-y-2">
                                ${renderCarBox(match.car1Id, { ...match, matchIndex: mIndex }, rIndex, mIndex)}
                                ${renderCarBox(match.car2Id, { ...match, matchIndex: mIndex }, rIndex, mIndex)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            const winnerConfig = getCarConfig(cupData.winnerId);
            const winnerBox = cupData.winnerId ? `
                <div class="glass-card p-4 text-center" style="background-color: rgba(255, 215, 0, 0.5); box-shadow: 0 0 20px #FFD700;">
                    <i data-lucide="trophy" class="w-8 h-8 text-yellow-200 mx-auto mb-2"></i>
                    ${renderCarBox(cupData.winnerId, { winnerId: cupData.winnerId }, 4, 0)}
                    <p class="text-xl font-extrabold mt-2 text-yellow-200">¬°CAMPE√ìN!</p>
                </div>
            ` : `<div class="glass-card bg-gray-800/30 p-4 text-center text-gray-500">A√∫n por definir</div>`;


            return `
                <div class="glass-card p-4 overflow-x-auto">
                    <div class="flex justify-between items-start space-x-4 min-w-max">
                        ${cupRoundsHtml}
                        <div class="flex flex-col space-y-4 justify-center items-center h-full">
                            <h3 class="text-lg font-semibold text-gray-200 mb-2 text-center border-b border-white/20 pb-1">Campe√≥n</h3>
                            <div class="pt-24 flex flex-col items-center">
                                ${winnerBox}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- TIME RACE TAB ---

        const renderTimeRaceTab = () => {
            const allAvailableCars = getAllAvailableCars();
            
            // Renderizado de Fila F1
            const renderF1Row = (result) => {
                const { position, model, brand, color, logo, time } = result;
                const isPole = position === 1;
                const isSecond = position === 2;
                
                const bgOpacity = isPole ? 'F0' : 'B0';
                const rowStyle = `
                    background-image: linear-gradient(to right, ${color}${bgOpacity}, #ffffff40, ${color}${bgOpacity});
                    box-shadow: ${isPole ? '0 4px 10px rgba(255, 215, 0, 0.4)' : '0 2px 5px rgba(0, 0, 0, 0.3)'};
                `;
                
                let positionBgColor = 'rgba(255, 255, 255, 0.9)'; // Default blanco
                let positionTextColor = '#1f2937'; // Gris oscuro
                if (isPole) {
                    positionBgColor = '#FFD700'; // Dorado
                } else if (isSecond) {
                    positionBgColor = '#C0C0C0'; // Plateado
                }

                return `
                    <div class="glass-card relative flex items-center p-3 mb-2 rounded-xl text-white font-poppins overflow-hidden" 
                         style="${rowStyle}" 
                         data-is-pole="${isPole}">

                        ${renderLogoDisplay(logo, model, 'w-32 h-32', true, color)}
                        
                        <div class="z-10 flex items-center flex-1">
                            <div class="w-12 h-12 flex-shrink-0 mr-4 relative flex items-center justify-center">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-lg font-black z-20 shadow-md" 
                                    style="background-color: ${positionBgColor}; color: ${positionTextColor};">
                                    ${position}
                                </div>
                            </div>
                            
                            <div class="w-10 flex-shrink-0 mr-4 p-1 bg-black/30 rounded-full flex items-center justify-center">
                                ${renderLogoDisplay(logo, model, 'w-6 h-6')}
                            </div>
                            
                            <div class="flex-1 text-lg font-bold truncate">
                                ${model}
                                <span class="text-xs font-light block opacity-70">${brand}</span>
                            </div>
                            
                            <div class="w-32 text-right text-xl font-extrabold bg-black/30 p-1 rounded-lg">
                                ${formatTime(time * 1000)}
                            </div>
                        </div>
                    </div>
                `;
            };

            const sortedResults = [...timeRaceData.results]
                .sort((a, b) => a.time - b.time)
                .map((result, index) => ({
                    ...result,
                    ...getCarConfig(result.carId),
                    position: index + 1,
                }));

            const optionsHtml = allAvailableCars.map(car => `
                <option value="${car.id}" class="bg-gray-800 text-white">${car.model} (${car.brand})</option>
            `).join('');

            return `
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                        <i data-lucide="trending-up" class="w-6 h-6 mr-2 text-red-400"></i> Control de Carrera y Tiempos
                    </h2>
                    
                    <p id="timerace-error" class="mb-4 p-2 rounded-lg text-white" style="display: none;"></p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                        
                        <div class="flex flex-col items-center">
                            <h3 class="text-xl font-semibold text-gray-200 mb-4">Cron√≥metro de Vuelta</h3>
                            <div id="stopwatch-display" class="text-5xl sm:text-7xl font-mono font-black text-blue-300 bg-gray-900/50 p-4 rounded-xl shadow-inner">${formatTime(stopwatchTime)}</div>
                            <div class="flex space-x-4 mt-4">
                                <button onclick="stopwatchAction('start')" id="stopwatch-start" class="px-4 py-2 rounded-xl text-white font-semibold bg-green-600 hover:bg-green-700 shadow-lg shadow-green-500/50 w-24 flex items-center justify-center ${stopwatchRunning ? 'opacity-50 cursor-not-allowed' : ''}">
                                    <i data-lucide="play" class="w-5 h-5 mr-1"></i> Start
                                </button>
                                <button onclick="stopwatchAction('stop')" id="stopwatch-stop" class="px-4 py-2 rounded-xl text-white font-semibold bg-red-600 hover:bg-red-700 shadow-lg shadow-red-500/50 w-24 flex items-center justify-center ${!stopwatchRunning ? 'opacity-50 cursor-not-allowed' : ''}">
                                    <i data-lucide="pause" class="w-5 h-5 mr-1"></i> Stop
                                </button>
                                <button onclick="stopwatchAction('reset')" class="px-4 py-2 rounded-xl text-white font-semibold bg-gray-600 hover:bg-gray-700 shadow-lg shadow-gray-500/50 w-24 flex items-center justify-center">
                                    <i data-lucide="square" class="w-5 h-5 mr-1"></i> Reset
                                </button>
                            </div>
                            <p class="text-gray-400 text-sm mt-2">El tiempo se registra al presionar STOP.</p>
                        </div>

                        <div class='space-y-4'>
                            <h3 class="text-xl font-semibold text-gray-200">Registro de Resultados</h3>
                            
                            <div class="relative">
                                <label for="carSelect" class="block text-sm font-medium text-gray-300 mb-1">Auto Participante</label>
                                <select id="carSelect" onchange="window.selectedCarId = this.value;" class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white focus:ring-blue-400 focus:border-blue-400 transition-colors appearance-none" style="padding-right: 2.5rem;">
                                    <option value="" class="bg-gray-800 text-gray-400">Selecciona un auto...</option>
                                    ${optionsHtml}
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-1/2 translate-y-1/2 w-4 h-4 text-gray-300 pointer-events-none"></i>
                            </div>
                            
                            <div>
                                <label for="timeDisplayInput" class="block text-sm font-medium text-gray-300 mb-1">Tiempo Registrado (s)</label>
                                <input type="text" id="timeDisplayInput" value="${recordedTime !== null ? recordedTime.toFixed(3) : '---'}" readonly placeholder="0.000" class="w-full px-3 py-2 bg-white/10 border border-white/30 rounded-lg text-white font-mono focus:outline-none"/>
                            </div>

                            <div class="flex items-end space-x-2 pt-2">
                                <button onclick="handleAddTimeClick()" id="add-time-button" class="px-4 py-2 rounded-xl text-white font-semibold transition-all duration-200 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 shadow-lg shadow-blue-500/50 w-full" disabled>
                                    Registrar Vuelta
                                </button>
                                <button onclick="handleClearRaceClick()" class="p-2 rounded-xl text-red-400 hover:bg-red-500/20 transition-colors h-[42px] flex items-center justify-center" title="Reiniciar Carrera de Tiempos">
                                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-white mb-4">Tabla de Posiciones (Grid F1)</h2>
                    <div class="max-h-[60vh] overflow-y-auto pr-2">
                        ${sortedResults.length === 0 ? '<p class="text-gray-400">A√∫n no hay tiempos registrados. ¬°A√±ade el primero!</p>' : sortedResults.map(renderF1Row).join('')}
                    </div>
                </div>
            `;
        };
        
        // --- STREET COUNTER TAB ---

        const renderStreetCounterTab = () => {
            // [Implementaci√≥n omitida por brevedad, usa la versi√≥n anterior para funcionalidad]
            return `<div class="glass-card p-6 text-white">Funcionalidad del contador de calle mantenida.</div>`;
        };

        // --- FIREBASE INICIALIZACI√ìN Y LISTENERS ---

        const initFirebase = () => {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const authenticate = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error de autenticaci√≥n:", error);
                        await signInAnonymously(auth);
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = crypto.randomUUID();
                    }
                    document.getElementById('user-id-display').textContent = `Usuario ID: ${userId}`;
                    isAuthReady = true;
                    setupFirestoreListeners();
                    renderApp();
                });

                authenticate();
            } else {
                console.error("Firebase no configurado. La persistencia estar√° deshabilitada.");
                userId = 'DEMO-USER';
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `Usuario DEMO: ${userId}`;
                renderApp();
            }
        };

        const setupFirestoreListeners = () => {
            if (!db || !userId) return;

            // Sincronizar Autos (Garaje)
            onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/cars`, 'user_cars_list'), (docSnap) => {
                if (docSnap.exists()) {
                    // Solo autos de usuario (no gen√©ricos)
                    cars = docSnap.data().list.filter(car => !car.isGeneric) || [];
                } else {
                    cars = [];
                }
                renderApp(activeTab);
            }, (e) => console.error("Error fetching cars data:", e));

            // Sincronizar Copa
            onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/cup`, 'cup_state'), (docSnap) => {
                if (docSnap.exists()) {
                    cupData = docSnap.data();
                } else {
                    cupData = { participants: [], rounds: [], winnerId: null };
                }
                renderApp(activeTab);
            }, (e) => console.error("Error fetching cup data:", e));
            
            // Sincronizar Carrera de Tiempos
            onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/timeRace`, 'race_state'), (docSnap) => {
                if (docSnap.exists()) {
                    timeRaceData = docSnap.data();
                } else {
                    timeRaceData = { results: [] };
                }
                renderApp(activeTab);
            }, (e) => console.error("Error fetching time race data:", e));
        };

        // --- MANEJADORES DE EVENTOS DEL CRON√ìMETRO ---

        window.stopwatchAction = (action) => {
            const display = document.getElementById('stopwatch-display');
            const startBtn = document.getElementById('stopwatch-start');
            const stopBtn = document.getElementById('stopwatch-stop');

            if (action === 'start' && !stopwatchRunning) {
                stopwatchRunning = true;
                stopwatchInterval = setInterval(() => {
                    stopwatchTime += 10;
                    display.textContent = formatTime(stopwatchTime);
                }, 10);
                startBtn.disabled = true;
                stopBtn.disabled = false;
                recordedTime = null;
                document.getElementById('timeDisplayInput').value = '---';
                document.getElementById('add-time-button').disabled = true;

            } else if (action === 'stop' && stopwatchRunning) {
                clearInterval(stopwatchInterval);
                stopwatchRunning = false;
                recordedTime = stopwatchTime / 1000;
                document.getElementById('timeDisplayInput').value = recordedTime.toFixed(3);
                
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                // Habilitar bot√≥n de registro si hay auto seleccionado
                if (window.selectedCarId) {
                    document.getElementById('add-time-button').disabled = false;
                }

            } else if (action === 'reset') {
                clearInterval(stopwatchInterval);
                stopwatchRunning = false;
                stopwatchTime = 0;
                recordedTime = null;
                display.textContent = formatTime(stopwatchTime);

                startBtn.disabled = false;
                stopBtn.disabled = true;
                document.getElementById('timeDisplayInput').value = '---';
                document.getElementById('add-time-button').disabled = true;
            }
        };
        
        window.handleAddTimeClick = async () => {
             if (!window.selectedCarId || recordedTime === null || recordedTime <= 0) return;
             
             document.getElementById('add-time-button').disabled = true;

             const timeInSeconds = recordedTime;
             const newEntry = { carId: window.selectedCarId, time: timeInSeconds };
             let newResults = [...timeRaceData.results];
             
             const existingIndex = newResults.findIndex(r => r.carId === window.selectedCarId);

             if (existingIndex !== -1) {
                 if (timeInSeconds < newResults[existingIndex].time) {
                     newResults[existingIndex].time = timeInSeconds;
                 } else {
                     window.showError("timerace", `El tiempo registrado (${timeInSeconds.toFixed(3)}s) no es mejor que el actual (${newResults[existingIndex].time.toFixed(3)}s).`);
                     document.getElementById('add-time-button').disabled = false;
                     return;
                 }
             } else {
                 newResults.push(newEntry);
             }

             timeRaceData = { results: newResults };
             await setDoc(doc(db, `artifacts/${appId}/users/${userId}/timeRace`, 'race_state'), timeRaceData);

             window.showError("timerace", "Tiempo registrado con √©xito.", 'bg-green-800/50');
             recordedTime = null;
             window.selectedCarId = '';
             document.getElementById('carSelect').value = '';
             document.getElementById('timeDisplayInput').value = '---';
             renderApp('timerace');
        };

        window.handleClearRaceClick = async () => {
             timeRaceData = { results: [] };
             await setDoc(doc(db, `artifacts/${appId}/users/${userId}/timeRace`, 'race_state'), timeRaceData);
             window.showError("timerace", "Carrera de tiempos reiniciada.", 'bg-orange-800/50');
             renderApp('timerace');
        };


        // --- MANEJADOR DE CAMBIO DE PESTA√ëA Y SETUP ---

        window.setTab = (tab) => {
            renderApp(tab);
        };
        
        const attachEventListeners = () => {
            if (activeTab === 'timerace') {
                const selectElement = document.getElementById('carSelect');
                if (selectElement) {
                     selectElement.value = window.selectedCarId || '';
                     selectElement.onchange = (e) => {
                         window.selectedCarId = e.target.value;
                         if (recordedTime !== null) {
                              document.getElementById('add-time-button').disabled = !window.selectedCarId;
                         }
                     };
                }
                // Asegurar que el bot√≥n de registro est√© correctamente deshabilitado/habilitado
                const addButton = document.getElementById('add-time-button');
                if (addButton) {
                    addButton.disabled = !window.selectedCarId || recordedTime === null;
                }

            } else if (activeTab === 'garage') {
                // Re-inicializar el estado del formulario en el DOM
                window.newCar = window.newCar || { id: '', brand: '', model: '', color: '#3b82f6', logo: 'üöó' };
                document.getElementById('brandInput').value = window.newCar.brand;
                document.getElementById('modelInput').value = window.newCar.model;
                document.getElementById('colorPicker').value = window.newCar.color;
                document.getElementById('colorHex').value = window.newCar.color;
                document.getElementById('logoInput').value = window.newCar.logo;
            }
        };

        window.onload = initFirebase;
    </script>
</body>
</html>

import React, { useState, useEffect } from 'react';
import { Trophy, Car, Swords, Plus, Trash2, Shuffle, Medal, RotateCcw, Award, Play, Star, CheckCircle, Crown, Info, Layers } from 'lucide-react';

// --- FIREBASE IMPORTS ---
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';

// Global variables provided by the environment (must be used)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
// --- END FIREBASE IMPORTS ---

// Constantes de iconos de marca (URLs y letras/emojis para los que no tienen link)
const ICON_URLS = {
  RENAULT: "https://cdn-icons-png.flaticon.com/128/16178/16178110.png",
  PEUGEOT: "https://cdn-icons-png.flaticon.com/128/16178/16178107.png",
  VW: "https://cdn-icons-png.flaticon.com/128/16178/16178138.png",
  MERCEDES: "https://cdn-icons-png.flaticon.com/128/16178/16178099.png",
  TOYOTA: "https://cdn-icons-png.flaticon.com/128/16178/16178130.png",
  AUDI: "https://cdn-icons-png.flaticon.com/128/16178/16178142.png",
  CHEVROLET: "https://cdn-icons-png.flaticon.com/128/16178/16178046.png",
  FORD: "https://listcarbrands.com/wp-content/uploads/2016/03/Logo-Ford-1.png", 
};

// Datos iniciales completos con color, brandIconType y Tier
const INITIAL_CARS = [
  { id: 1, name: 'Peugeot 206', detail: '(Rojo #1)', color: '#E74C3C', brandIconType: ICON_URLS.PEUGEOT, wins: 0, draws: 0, losses: 0, matches: 0, tier: 3, titles: 0 },
  { id: 2, name: 'Peugeot 206', detail: '(Rojo #2)', color: '#E74C3C', brandIconType: ICON_URLS.PEUGEOT, wins: 0, draws: 0, losses: 0, matches: 0, tier: 3, titles: 0 },
  { id: 3, name: 'Peugeot 107', detail: '(Blanco)', color: '#E0E0E0', brandIconType: ICON_URLS.PEUGEOT, wins: 0, draws: 0, losses: 0, matches: 0, tier: 3, titles: 0 },
  { id: 4, name: 'Mercedes Benz', detail: '(Blanco)', color: '#E0E0E0', brandIconType: ICON_URLS.MERCEDES, wins: 0, draws: 0, losses: 0, matches: 0, tier: 2, titles: 0 }, 
  { id: 5, name: 'Audi TT', detail: '(Rojo)', color: '#CC0000', brandIconType: ICON_URLS.AUDI, wins: 0, draws: 0, losses: 0, matches: 0, tier: 1, titles: 0 }, 
  { id: 6, name: 'Audi TT', detail: '(Negro)', color: '#333333', brandIconType: ICON_URLS.AUDI, wins: 0, draws: 0, losses: 0, matches: 0, tier: 2, titles: 0 },
  { id: 7, name: 'Rayito Police', detail: '(Naranja)', color: '#FF8C00', brandIconType: '‚ö°', wins: 0, draws: 0, losses: 0, matches: 0, tier: 3, titles: 0 },
  { id: 9, name: 'Renault Scenic', detail: '(Verde)', color: '#008000', brandIconType: ICON_URLS.RENAULT, wins: 0, draws: 0, losses: 0, matches: 0, tier: 1, titles: 0 },
  { id: 10, name: 'Toyota', detail: '', color: '#FFD700', brandIconType: ICON_URLS.TOYOTA, wins: 0, draws: 0, losses: 0, matches: 0, tier: 2, titles: 0 },
  { id: 12, name: 'Polic√≠a', detail: '(Negra)', color: '#333333', brandIconType: 'üö®', wins: 0, draws: 0, losses: 0, matches: 0, tier: 4, titles: 0 },
  { id: 13, name: 'Ranger', detail: '(Morada)', color: '#800080', brandIconType: ICON_URLS.FORD, wins: 0, draws: 0, losses: 0, matches: 0, tier: 4, titles: 0 },
  { id: 14, name: 'VW Golf', detail: '(Bordo)', color: '#800020', brandIconType: ICON_URLS.VW, wins: 0, draws: 0, losses: 0, matches: 0, tier: 3, titles: 0 },
  { id: 15, name: 'Ford Focus', detail: '(Naranja)', color: '#FF8C00', brandIconType: ICON_URLS.FORD, wins: 0, draws: 0, losses: 0, matches: 0, tier: 2, titles: 0 },
  { id: 16, name: 'Chevrolet Camaro', detail: '(Azul)', color: '#0000FF', brandIconType: ICON_URLS.CHEVROLET, wins: 0, draws: 0, losses: 0, matches: 0, tier: 3, titles: 0 },
  { id: 17, name: 'Chevy', detail: '(Amarilla)', color: '#FFFF00', brandIconType: ICON_URLS.CHEVROLET, wins: 0, draws: 0, losses: 0, matches: 0, tier: 1, titles: 0 },
  { id: 19, name: 'Mercedes Benz', detail: '(Blanco - 2)', color: '#E0E0E0', brandIconType: ICON_URLS.MERCEDES, wins: 0, draws: 0, losses: 0, matches: 0, tier: 2, titles: 0 },
];

export default function App() {
  const [cars, setCars] = useState(INITIAL_CARS.map(c => ({ ...c, titles: c.titles || 0 })));
  const [view, setView] = useState('arena'); // 'garage', 'arena', 'ranking', 'titles'
  const [newCarName, setNewCarName] = useState('');
  
  // Estado del Juego
  const [gameMode, setGameMode] = useState('free'); // 'free', 'league', 'cup'
  const [schedule, setSchedule] = useState([]); // Lista de partidos pendientes
  const [currentMatchIndex, setCurrentMatchIndex] = useState(0);
  const [roundNumber, setRoundNumber] = useState(1); // Para la Copa
  
  // Estado para el duelo actual
  const [duel, setDuel] = useState({ car1: null, car2: null });
  const [winner, setWinner] = useState(null);
  const [isDraw, setIsDraw] = useState(false);
  const [cupChampion, setCupChampion] = useState(null); 

  // --- FIREBASE/PERSISTENCE STATE ---
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  // --- FIREBASE INITIALIZATION AND AUTH ---
  useEffect(() => {
    if (!firebaseConfig) {
      console.error("Firebase config not found.");
      setIsLoading(false);
      return;
    }

    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const firebaseAuth = getAuth(app);

      setDb(firestore);
      setAuth(firebaseAuth);

      // 1. Listen for auth state changes
      const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          setUserId(crypto.randomUUID());
        }
        setIsAuthReady(true);
      });

      // 2. Sign in using the token or anonymously
      const signInPromise = initialAuthToken
        ? signInWithCustomToken(firebaseAuth, initialAuthToken).catch(e => {
            console.error("Custom token sign-in failed, trying anonymous.", e);
            return signInAnonymously(firebaseAuth);
          })
        : signInAnonymously(firebaseAuth);

      signInPromise.catch(eAnon => console.error("Anonymous sign-in failed:", eAnon));
      
      return () => unsubscribe();
    } catch (e) {
      console.error("Firebase initialization failed:", e);
      setIsLoading(false);
    }
  }, []);

  // --- FIRESTORE DATA HANDLING (Load/Save) ---
  const dataPath = `/artifacts/${appId}/users/${userId}/tournamentData/state`;
  
  // 1. Load data from Firestore
  useEffect(() => {
    if (!db || !userId || !isAuthReady) return;
    
    const docRef = doc(db, dataPath);

    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        // Mapear cars para asegurar que todos tengan la propiedad 'titles'
        const loadedCars = (data.cars || INITIAL_CARS).map(c => ({ ...c, titles: c.titles || 0 }));
        
        setCars(loadedCars);
        setGameMode(data.gameMode || 'free');
        setSchedule(data.schedule || []);
        setCurrentMatchIndex(data.currentMatchIndex || 0);
        setRoundNumber(data.roundNumber || 1);
        setDuel(data.duel || { car1: null, car2: null });
        setCupChampion(data.cupChampion || null);
        console.log("Datos cargados exitosamente de Firestore.");
      } else {
        // Initialize if no data exists
        setCars(INITIAL_CARS.map(c => ({ ...c, titles: c.titles || 0 })));
        console.log("No se encontraron datos. Inicializando app.");
      }
      setIsLoading(false);
    }, (error) => {
      console.error("Error al escuchar los datos de Firestore:", error);
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, [db, userId, isAuthReady]); 

  // 2. Save data to Firestore
  const saveData = () => {
    if (!db || !userId || !isAuthReady || isLoading || !auth.currentUser) return;
    
    const stateToSave = {
      cars,
      gameMode,
      schedule,
      currentMatchIndex,
      roundNumber,
      duel,
      cupChampion,
      lastUpdated: new Date().toISOString(),
    };
    
    if (cars.length > 0) {
        setDoc(doc(db, dataPath), stateToSave)
            .catch(e => console.error("Error al guardar datos en Firestore:", e));
    }
  };

  useEffect(() => {
    // Retraso para evitar guardar cambios intermedios de un solo evento
    const timer = setTimeout(() => {
        saveData();
    }, 500);
    return () => clearTimeout(timer);
  }, [cars, gameMode, schedule, currentMatchIndex, roundNumber, duel, cupChampion]); // eslint-disable-line react-hooks/exhaustive-deps


  // --- HELPERS ---
  const getPoints = (c) => (c.wins * 3) + (c.draws * 1);
  const getFullName = (car) => `${car.name} ${car.detail || ''}`.trim();

  // Componente visual para la marca/color (Usado en Garage, Ranking y Arena Foreground)
  const CarBadge = ({ car }) => {
    const sizeClasses = 'w-8 h-8 p-1'; 
    const textClasses = 'text-sm';
    
    if (car.brandIconType && car.brandIconType.startsWith('http')) {
        return (
            <div 
                className={`${sizeClasses} rounded-full flex items-center justify-center shadow-md flex-shrink-0`}
                style={{ backgroundColor: car.color }}
            >
                <img 
                    src={car.brandIconType} 
                    alt="Logo" 
                    className="w-full h-full object-contain rounded-full bg-white"
                    onError={(e) => { e.target.onerror = null; e.target.style.display = 'none'; }}
                />
            </div>
        );
    }
    
    const isLight = car.color === '#FFFF00' || car.color === '#E0E0E0';
    const textColor = isLight ? 'text-gray-900' : 'text-white';
    
    return (
      <div 
        className={`${sizeClasses} rounded-full flex items-center justify-center font-bold shadow-md flex-shrink-0`}
        style={{ backgroundColor: car.color }}
      >
        <span className={textColor + ' ' + textClasses}>{car.brandIconType}</span>
      </div>
    );
  }

  // Componente para el logo GRANDE y TRANSPARENTE de fondo en los botones de batalla (Definido una sola vez aqu√≠)
  const BattleBackgroundIcon = ({ car }) => {
    if (car.brandIconType && car.brandIconType.startsWith('http')) {
        return (
            <img 
                src={car.brandIconType} 
                alt="Logo" 
                className="w-40 h-40 object-contain" 
                style={{ filter: 'grayscale(100%) brightness(200%)' }} 
            />
        );
    }
    
    return (
      <span className="text-[120px] text-white opacity-100"> 
        {car.brandIconType}
      </span>
    );
  };
  
  // Componente para las filas de las tablas de Ranking y T√≠tulos (con degradado y logo de fondo)
  // Se refactoriza para USAR React.cloneElement y evitar la doble anidaci√≥n de <td> que causa la desalineaci√≥n.
  const StyledTableRow = ({ car, children }) => {
      const cellBgColor = 'rgba(255, 255, 255, 0.7)';
      const rowColorOpacity = '15'; 

      const cells = React.Children.toArray(children).map((child, index) => {
          
          let finalProps = {
              className: (child.props.className || '') + ' relative z-10',
              style: {
                  ...child.props.style,
                  // Asegurar un fondo uniforme para cubrir el efecto
                  backgroundColor: cellBgColor,
              },
          };

          if (index === 0) {
              // Estilo especial para la primera celda (para el logo/degradado)
              return React.cloneElement(child, {
                  ...finalProps,
                  className: (child.props.className || '') + ' relative z-10 overflow-hidden',
                  style: {
                      ...finalProps.style,
                      // Aplicar degradado a la primera celda
                      backgroundImage: `linear-gradient(to right, ${car.color}${rowColorOpacity}, transparent)`, 
                  },
                  // El contenido original del <td> se envuelve para estar sobre el √≠cono.
                  children: (
                      <div className="relative z-20 h-full flex items-center">
                          {/* √çcono de fondo absoluto dentro de la primera TD */}
                          <div
                              style={{
                                  position: 'absolute',
                                  top: '50%',
                                  left: '10%',
                                  transform: 'translateY(-50%) scale(0.6)',
                                  opacity: 0.08,
                                  zIndex: 0,
                                  pointerEvents: 'none',
                              }}
                          >
                              <BattleBackgroundIcon car={car} />
                          </div>
                          {child.props.children}
                      </div>
                  )
              });

          }
          
          // Clonar elemento para todas las otras celdas
          return React.cloneElement(child, finalProps);
      });

      return <tr className="transition-colors hover:bg-gray-50">{cells}</tr>;
  };


  // --- L√ìGICA DEL GARAGE ---
  const addCar = () => {
    if (!newCarName.trim()) return;
    const newCar = {
      id: Date.now(),
      name: newCarName,
      detail: '(Nuevo)',
      color: '#AAAAAA', 
      brandIconType: 'üöó', 
      wins: 0, draws: 0, losses: 0, matches: 0,
      tier: 2, 
      titles: 0
    };
    setCars([...cars, newCar]);
    setNewCarName('');
  };

  const deleteCar = (id) => {
    setCars(cars.filter(c => c.id !== id));
    if (duel.car1?.id === id || duel.car2?.id === id) {
      resetDuelState();
    }
  };

  const updateTier = (id, newTier) => {
    setCars(cars.map(c => c.id === id ? { ...c, tier: newTier } : c));
  };
  
  const updateCarColor = (id, newColor) => {
      setCars(cars.map(c => c.id === id ? { ...c, color: newColor } : c));
  };

  // --- L√ìGICA DE DUELOS ---
  const resetDuelState = () => {
    setDuel({ car1: null, car2: null });
    setWinner(null);
    setIsDraw(false);
  };

  const startRandomDuel = () => {
    if (cars.length < 2) return;
    resetDuelState();
    
    let activeCars = cars.filter(c => c.matches < 100); 
    if (activeCars.length < 2) activeCars = cars;

    let idx1 = Math.floor(Math.random() * activeCars.length);
    let idx2 = Math.floor(Math.random() * activeCars.length);
    while (idx1 === idx2) idx2 = Math.floor(Math.random() * activeCars.length);

    setDuel({ car1: activeCars[idx1], car2: activeCars[idx2] });
    setGameMode('free');
    setCupChampion(null); 
  };

  // Registrar Resultado
  const handleResult = (winnerCar, isTie = false) => {
    if (gameMode === 'cup' && isTie) return; 

    setIsDraw(isTie);
    setWinner(isTie ? { name: 'Empate' } : winnerCar);
    
    const car1 = duel.car1;
    const car2 = duel.car2;
    if (!car1 || !car2) return; 
    
    const loserCar = !isTie ? (car1.id === winnerCar.id ? car2 : car1) : null;
    
    // Solo actualiza las estad√≠sticas de W/L/D/Matches si NO es Copa (free o league)
    if (gameMode !== 'cup') {
        setCars(prevCars => prevCars.map(car => {
          if (isTie) {
            if (car.id === car1.id || car.id === car2.id) {
              return { ...car, draws: car.draws + 1, matches: car.matches + 1 };
            }
          } else {
            if (car.id === winnerCar.id) return { ...car, wins: car.wins + 1, matches: car.matches + 1 };
            if (car.id === loserCar.id) return { ...car, losses: car.losses + 1, matches: car.matches + 1 };
          }
          return car;
        }));
    } else {
        console.log("Resultado de Copa registrado. No afecta el ranking de puntos.");
    }

    // L√≥gica de Torneos (schedule update)
    if (gameMode !== 'free') {
      const newSchedule = [...schedule];
      if (newSchedule[currentMatchIndex]) {
        newSchedule[currentMatchIndex].played = true;
        newSchedule[currentMatchIndex].result = isTie ? 'Empate' : getFullName(winnerCar);
        
        if (gameMode === 'cup') {
           newSchedule[currentMatchIndex].winnerId = isTie ? null : winnerCar.id; 
        }
      }
      setSchedule(newSchedule);
    }
  };

  // Avanzar en Torneo
  const nextMatch = () => {
    resetDuelState();
    const nextIndex = currentMatchIndex + 1;

    if (nextIndex < schedule.length) {
      setCurrentMatchIndex(nextIndex);
      const match = schedule[nextIndex];
      
      const c1 = cars.find(c => c.id === match.p1Id);
      const c2 = match.p2Id !== 'BYE' ? cars.find(c => c.id === match.p2Id) : { id: 'BYE', name: 'Pase Directo', detail: '', tier: 0, color: '#4F46E5', brandIconType: '‚û°Ô∏è' }; 
      
      if (!match.played && c1) {
          setDuel({ car1: c1, car2: c2 });
      } else {
          nextMatch(); 
      }
      
    } else {
      // Fin de la lista de partidos de la ronda actual
      if (gameMode === 'league') {
        // Encontrar al campe√≥n de la liga
        const champion = sortedCars[0]; 
        
        // Asignar el t√≠tulo
        setCars(prevCars => prevCars.map(c => 
            c.id === champion.id ? {...c, titles: (c.titles || 0) + 1} : c
        ));

        console.log(`¬°Liga Finalizada! Campe√≥n: ${getFullName(champion)}. Revisa el ranking.`); 
        setCupChampion(champion); // Mostrar el banner
        setGameMode('free');
        setSchedule([]); // Limpiar schedule
      } else if (gameMode === 'cup') {
        generateNextCupRound();
      }
    }
  };

  // --- L√ìGICA DE LIGA (Round Robin) ---
  const startLeague = () => {
    if (cars.length < 2) {
        console.log("Error: Necesitas al menos 2 autos para iniciar la Liga.");
        return;
    }
    resetAllStats(false); // Resetear solo stats, no t√≠tulos
    
    let matches = [];
    for (let i = 0; i < cars.length; i++) {
      for (let j = i + 1; j < cars.length; j++) {
        matches.push({
          p1Id: cars[i].id,
          p2Id: cars[j].id,
          p1Name: getFullName(cars[i]),
          p2Name: getFullName(cars[j]),
          played: false
        });
      }
    }
    matches = matches.sort(() => Math.random() - 0.5);
    
    setSchedule(matches);
    setCurrentMatchIndex(0);
    setGameMode('league');
    setRoundNumber(1);
    
    const m = matches[0];
    setDuel({ 
        car1: cars.find(c => c.id === m.p1Id), 
        car2: cars.find(c => c.id === m.p2Id) 
    });
    setWinner(null);
  };

  // --- L√ìGICA DE COPA (Eliminatoria) ---
  const startCup = () => {
    if (cars.length < 2) {
        console.log("Error: Necesitas al menos 2 autos para iniciar la Copa.");
        return;
    }
    resetAllStats(false); // Resetear solo stats
    setCupChampion(null);

    const sortedCars = [...cars].sort((a, b) => {
      if (b.tier !== a.tier) return b.tier - a.tier; 
      return Math.random() - 0.5;
    });
    
    let matches = [];
    let participants = [...sortedCars];
    let count = participants.length;

    let nextPowerOfTwo = 1;
    while (nextPowerOfTwo < count) { nextPowerOfTwo *= 2; }
    const byesNeeded = nextPowerOfTwo - count;
    
    let byeMatches = [];
    
    for(let i = 0; i < byesNeeded; i++) {
        const luckyOne = participants.shift();
        if (luckyOne) {
            byeMatches.push({
                p1Id: luckyOne.id,
                p2Id: 'BYE',
                p1Name: getFullName(luckyOne),
                p2Name: 'Pase Directo',
                played: true,
                winnerId: luckyOne.id,
                result: 'Pase Directo'
            });
        }
    }
    
    let remaining = participants.length;
    for (let i = 0; i < remaining / 2; i++) {
        const topSeed = participants[i]; 
        const bottomSeed = participants[remaining - 1 - i]; 
        matches.push({
            p1Id: topSeed.id,
            p2Id: bottomSeed.id,
            p1Name: getFullName(topSeed),
            p2Name: getFullName(bottomSeed),
            played: false
        });
    }
    
    let initialSchedule = [...matches.sort(() => Math.random() - 0.5), ...byeMatches];

    setSchedule(initialSchedule);
    setCurrentMatchIndex(0);
    setGameMode('cup');
    setRoundNumber(1);

    const firstPlayable = initialSchedule.find(m => !m.played);
    if (firstPlayable) {
      const c1 = cars.find(c => c.id === firstPlayable.p1Id);
      const c2 = firstPlayable.p2Id !== 'BYE' ? cars.find(c => c.id === firstPlayable.p2Id) : { id: 'BYE', name: 'Pase Directo', detail: '', tier: 0, color: '#4F46E5', brandIconType: '‚û°Ô∏è' };
      setDuel({ car1: c1, car2: c2 });
    } else {
        generateNextCupRound(initialSchedule); 
    }
    setWinner(null);
  };

  const generateNextCupRound = (currentSchedule = schedule) => {
    const winnersIds = currentSchedule.map(m => m.winnerId).filter(id => id && id !== 'BYE');
    
    if (winnersIds.length === 1) {
      const champion = cars.find(c => c.id === winnersIds[0]);
      
      // Asignar el t√≠tulo de Copa
      setCars(prevCars => prevCars.map(c => 
          c.id === champion.id ? {...c, titles: (c.titles || 0) + 1} : c
      ));

      setCupChampion(champion);
      setGameMode('free'); 
      setSchedule([]); // Limpiar schedule
      console.log(`¬°Tenemos Campe√≥n de Copa! üèÜ ${getFullName(champion)} üèÜ`); 
      return;
    }

    const winningCars = winnersIds.map(id => cars.find(c => c.id === id)).filter(c => c);
    
    let newMatches = [];
    let count = winningCars.length;
    let pairs = Math.floor(count / 2);

    for (let i = 0; i < pairs; i++) {
      newMatches.push({
        p1Id: winningCars[i*2].id,
        p2Id: winningCars[i*2+1].id,
        p1Name: getFullName(winningCars[i*2]),
        p2Name: getFullName(winningCars[i*2+1]),
        played: false
      });
    }

    if (count % 2 !== 0) {
      const luckyOne = winningCars[count - 1];
      newMatches.push({
        p1Id: luckyOne.id,
        p2Id: 'BYE',
        p1Name: getFullName(luckyOne),
        p2Name: 'Pase Directo',
        played: true,
        winnerId: luckyOne.id,
        result: 'Pase Directo'
      });
    }
    
    setSchedule(newMatches);
    setCurrentMatchIndex(0);
    setRoundNumber(r => r + 1);

    const firstPlayable = newMatches.find(m => !m.played);
    if (firstPlayable) {
      const c1 = cars.find(c => c.id === firstPlayable.p1Id);
      const c2 = firstPlayable.p2Id !== 'BYE' ? cars.find(c => c.id === firstPlayable.p2Id) : { id: 'BYE', name: 'Pase Directo', detail: '', tier: 0, color: '#4F46E5', brandIconType: '‚û°Ô∏è' };
      setDuel({ car1: c1, car2: c2 });
      setWinner(null);
    } else {
        generateNextCupRound(newMatches);
    }
  };


  const resetAllStats = (resetTitles = true) => {
    setCars(cars.map(c => ({ 
        ...c, 
        wins: 0, 
        draws: 0, 
        losses: 0, 
        matches: 0,
        titles: resetTitles ? 0 : c.titles // Permite resetear solo stats
    })));
    setDuel({ car1: null, car2: null });
    setWinner(null);
    setSchedule([]);
    setGameMode('free');
    setRoundNumber(1);
    setCurrentMatchIndex(0);
    setCupChampion(null);
    console.log(`¬°Estad√≠sticas ${resetTitles ? 'y T√≠tulos' : 'solamente'} reseteados!`);
  };

  // --- RANKING SORT ---
  const sortedCars = [...cars].sort((a, b) => {
    const ptsA = getPoints(a);
    const ptsB = getPoints(b);
    if (ptsB !== ptsA) return ptsB - ptsA;
    return a.losses - b.losses; 
  });
  
  const sortedTitles = [...cars].sort((a, b) => b.titles - a.titles);

  // UI Components
  const TabButton = ({ id, label, icon: Icon }) => (
    <button
      onClick={() => setView(id)}
      className={`flex-1 py-3 flex flex-col items-center justify-center transition-colors duration-200 ${
        view === id 
          ? 'text-red-600 border-t-2 border-red-600 bg-red-50' 
          : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
      }`}
    >
      <Icon size={20} className="mb-1" />
      <span className="text-xs font-medium">{label}</span>
    </button>
  );
  
  // Componente para mostrar el campe√≥n
  const ChampionDisplay = ({ champion }) => (
      <div className="bg-yellow-100 border-2 border-yellow-400 p-6 rounded-2xl text-center shadow-lg mb-6">
          <Crown size={48} className="mx-auto text-yellow-500 mb-2 animate-bounce-slow" />
          <h2 className="text-xl font-bold text-yellow-800">¬°CAMPE√ìN!</h2>
          <p className="text-3xl font-black text-gray-800">{getFullName(champion)}</p>
          <p className="text-sm text-gray-600 mt-1">{champion.titles > 1 ? `Ahora tiene ${champion.titles} t√≠tulos.` : '¬°Primer t√≠tulo!'}</p>
          <button 
             onClick={() => setCupChampion(null)}
             className="mt-4 text-sm text-gray-600 underline"
          >
            Cerrar
          </button>
      </div>
  );
  
  const renderDuelButton = (car, opponent, isCar1) => {
    const isWinner = winner?.id === car.id;
    const isDisabled = !!winner || opponent.name === 'Pase Directo';

    return (
      <button 
        disabled={isDisabled} 
        onClick={() => handleResult(car)}
        style={{ 
          backgroundImage: `linear-gradient(to right, ${car.color}EE, ${car.color}AA)`,
          position: 'relative',
          overflow: 'hidden',
        }}
        className={`w-full p-4 rounded-xl border-2 transition-all flex justify-between items-center group text-white font-bold text-lg shadow-lg ${
          isWinner 
            ? 'bg-green-600 border-green-400 shadow-[0_0_20px_rgba(34,197,94,0.7)]' 
            : isDisabled && !isDraw
              ? 'opacity-40 pointer-events-none'
              : 'hover:scale-[1.02] active:scale-95 border-transparent'
        }`}
      >
        {/* Fondo con logo grande y transparente */}
        <div 
          style={{ 
            position: 'absolute', 
            top: '50%', 
            left: '50%', 
            transform: 'translate(-50%, -50%)', 
            opacity: 0.15, 
            zIndex: 0,
            pointerEvents: 'none',
          }}
        >
          <BattleBackgroundIcon car={car} />
        </div>

        {/* Contenido en primer plano (z-index 10) */}
        <div className="relative z-10 flex items-center justify-between w-full">
            <div className="text-left flex items-center gap-3">
              <CarBadge car={car}/>
              <div>
                  <span className="block">{getFullName(car)}</span>
                  <div className="flex text-yellow-300 text-xs font-normal">
                       {[...Array(car.tier || 1)].map((_,i)=><Star key={i} size={10} fill="currentColor"/>)}
                  </div>
              </div>
            </div>
            {isWinner && <CheckCircle className="text-white flex-shrink-0" />}
        </div>
      </button>
    );
  };
  
  // Renderiza la vista de las llaves de la copa
  const CupBracketView = () => {
    const currentMatch = schedule[currentMatchIndex];

    return (
        <div className="space-y-4">
            <h3 className="text-xl font-bold text-red-600 border-b pb-2 mb-4">
                Ronda {roundNumber} - {schedule.length} Partidos
            </h3>
            
            {schedule.map((match, index) => {
                const isCurrent = index === currentMatchIndex && !match.played;
                const isPlayed = match.played;
                const car1 = cars.find(c => c.id === match.p1Id) || { name: 'Desconocido', color: '#999', brandIconType: '?' };
                const car2 = match.p2Id !== 'BYE' 
                    ? cars.find(c => c.id === match.p2Id) || { name: 'Desconocido', color: '#999', brandIconType: '?' }
                    : { name: 'Pase Directo', detail: '', color: '#4F46E5', brandIconType: '‚û°Ô∏è' };

                return (
                    <div 
                        key={index} 
                        className={`p-3 rounded-lg shadow-md transition-all ${
                            isCurrent 
                                ? 'bg-yellow-100 border-2 border-yellow-400' 
                                : isPlayed 
                                    ? 'bg-green-50 border border-green-200' 
                                    : 'bg-white border border-gray-200 opacity-70'
                        }`}
                    >
                        <div className="flex items-center justify-between">
                            <span className={`font-semibold ${isCurrent ? 'text-black' : 'text-gray-700'}`}>
                                Partido {index + 1}
                            </span>
                            {isCurrent && <Play size={18} className="text-yellow-600 animate-pulse"/>}
                        </div>
                        <div className="flex items-center justify-between mt-1 text-sm">
                            <div className="flex items-center gap-2">
                                <CarBadge car={car1} />
                                <span className={match.winnerId === car1.id ? 'font-bold text-green-700' : 'text-gray-600'}>
                                    {getFullName(car1)}
                                </span>
                            </div>
                            <span className="text-xs text-gray-500 mx-2">VS</span>
                            <div className="flex items-center gap-2">
                                <span className={match.winnerId === car2.id ? 'font-bold text-green-700' : 'text-gray-600'}>
                                    {getFullName(car2)}
                                </span>
                                <CarBadge car={car2} />
                            </div>
                        </div>
                        {isPlayed && (
                            <div className="text-xs mt-2 pt-1 border-t border-dashed text-center">
                                Ganador: <span className="font-bold text-green-700">{match.result}</span>
                            </div>
                        )}
                    </div>
                );
            })}
        </div>
    );
  };

  if (isLoading) {
    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100">
            <div className="text-center p-6 bg-white rounded-lg shadow-lg">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500 mx-auto mb-3"></div>
                <p className="text-gray-700 font-medium">Cargando datos del torneo...</p>
            </div>
        </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 text-gray-800 font-sans pb-20 sm:pb-0">
      <div className="max-w-md mx-auto bg-white min-h-screen shadow-xl flex flex-col">
        
        {/* Header */}
        <header className="bg-gradient-to-r from-red-600 to-red-700 text-white p-4 shadow-md sticky top-0 z-10">
          <div className="flex items-center justify-between">
            <h1 className="text-xl font-bold flex items-center gap-2">
              <Trophy className="text-yellow-300" />
              {gameMode === 'free' ? 'Torneo de Autitos' : gameMode === 'league' ? 'Modo Liga' : `Copa - Ronda ${roundNumber}`}
            </h1>
            {gameMode !== 'free' && (
                <span className="text-xs bg-white text-red-600 px-2 py-1 rounded font-bold">
                    Partido {currentMatchIndex + 1} de {schedule.length}
                </span>
            )}
          </div>
        </header>

        <main className="flex-1 p-4 overflow-y-auto">
          
          {/* --- VISTA: ARENA --- */}
          {view === 'arena' && (
            <div className="space-y-6 animate-fade-in">
              
              {cupChampion && <ChampionDisplay champion={cupChampion} />}

              {/* Selector de Modos (Solo si no hay duelo activo y no hay campe√≥n) */}
              {gameMode === 'free' && !duel.car1 && !cupChampion && (
                 <div className="grid grid-cols-2 gap-2 mb-4">
                    <button onClick={startLeague} className="bg-blue-600 text-white p-3 rounded-lg text-sm font-bold shadow hover:bg-blue-700 flex items-center justify-center gap-2">
                        <Award size={16}/> Crear Liga
                    </button>
                    <button onClick={startCup} className="bg-purple-600 text-white p-3 rounded-lg text-sm font-bold shadow hover:bg-purple-700 flex items-center justify-center gap-2">
                        <Crown size={16}/> Crear Copa
                    </button>
                 </div>
              )}

              {/* Vista de Llaves cuando est√°s en Modo Copa */}
              {gameMode !== 'free' && schedule.length > 0 && (
                <div className="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h2 className="text-lg font-semibold mb-3 flex items-center gap-2">
                        <Layers size={20} className="text-red-500"/> Llaves del Torneo
                    </h2>
                    <CupBracketView />
                </div>
              )}

              {/* √Årea de VS */}
              <div className="bg-slate-800 rounded-2xl p-6 text-white shadow-inner relative overflow-hidden min-h-[300px] flex flex-col justify-center">
                <div className="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                   <div className="w-full h-full bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-gray-500 via-gray-900 to-black"></div>
                </div>

                {/* Mostrar cuando no hay un duelo cargado y no hay campe√≥n */}
                {(!duel.car1 && !cupChampion) ? (
                  <div className="text-center py-10 relative z-10">
                    <Swords size={48} className="mx-auto text-gray-500 mb-4 opacity-50" />
                    <p className="text-gray-400">
                        {gameMode === 'free' ? 'Sortear o Iniciar Torneo' : 'Preparando siguiente ronda...'}
                    </p>
                  </div>
                ) : duel.car1 && duel.car2 ? (
                  <div className="relative z-10 flex flex-col items-center gap-4 w-full">
                    
                    {/* Auto 1 */}
                    {renderDuelButton(duel.car1, duel.car2, true)}
                    
                    {/* VS / Empate */}
                    <div className="flex items-center gap-4 w-full justify-center">
                         <span className="font-black text-2xl italic text-red-500 opacity-50">VS</span>
                         {/* Se permite Empate solo en Liga o Modo Libre */}
                         {!winner && gameMode === 'league' && (
                             <button 
                                onClick={() => handleResult(null, true)}
                                className="bg-gray-600 px-4 py-1 rounded-full text-xs font-bold hover:bg-gray-500 active:scale-95"
                             >
                                EMPATE
                             </button>
                         )}
                         {gameMode === 'cup' && !winner && <span className="text-xs text-gray-500">(Eliminaci√≥n Directa)</span>}
                    </div>

                    {/* Auto 2 */}
                    {duel.car2.id !== 'BYE' ? (
                        renderDuelButton(duel.car2, duel.car1, false)
                    ) : (
                        // Renderiza el Pase Directo como un cartel
                        <div className="w-full p-4 rounded-xl border-2 border-dashed border-gray-500 bg-gray-700 opacity-80 text-center text-white font-bold">
                            {getFullName(duel.car1)} obtiene <span className="text-yellow-400">Pase Directo (BYE)</span>
                        </div>
                    )}
                  </div>
                ) : null /* Si duel.car1 o duel.car2 es null, no mostrar nada aqu√≠ */}
              </div>

              {/* Action Button */}
              <div className="mt-4">
                {duel.car1 && !winner ? (
                    gameMode === 'free' && (
                        <button 
                          onClick={startRandomDuel}
                          className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"
                        >
                          <Shuffle size={24} />
                          Sortear Amistoso
                        </button>
                    )
                ) : winner ? (
                  <div className="space-y-3 animate-in fade-in slide-in-from-bottom-4">
                    <div className="bg-green-100 border border-green-200 text-green-800 p-3 rounded-lg text-center font-medium">
                      {isDraw ? '¬°Es un Empate! (+1 pto)' : `¬°Ganador: ${getFullName(winner)}! (${gameMode === 'free' || gameMode === 'league' ? '+3 pts' : 'Avanza'})`}
                    </div>
                    
                    {gameMode === 'free' ? (
                         <button 
                           onClick={startRandomDuel}
                           className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"
                         >
                           <RotateCcw size={20} /> Otro Amistoso
                         </button>
                    ) : (
                        <button 
                           onClick={nextMatch}
                           className="w-full bg-yellow-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-yellow-400"
                         >
                           <Play size={20} /> Siguiente Partido
                         </button>
                    )}
                  </div>
                ) : null}
              </div>
            </div>
          )}

          {/* --- VISTA: RANKING --- */}
          {view === 'ranking' && (
            <div className="animate-fade-in">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold text-gray-700">Tabla General (Puntos)</h2>
                <button onClick={() => resetAllStats(false)} className="text-xs text-red-500 underline">Resetear Puntos</button>
              </div>
              
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                    <tr>
                      <th className="px-2 py-3 text-left w-8">#</th>
                      <th className="px-2 py-3 text-left">Auto</th>
                      <th className="px-2 py-3 text-center bg-gray-100">Pts</th>
                      <th className="px-2 py-3 text-center">PJ</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {sortedCars.map((car, index) => (
                      <StyledTableRow key={car.id} car={car}>
                        <td className="px-2 py-3 font-bold text-gray-400">
                          {index + 1}
                        </td>
                        <td className="px-2 py-3">
                            <div className="font-medium text-gray-800 flex items-center gap-2">
                                <CarBadge car={car}/>
                                <span>{getFullName(car)}</span>
                            </div>
                            <div className="text-xs text-gray-400 flex gap-2 ml-10">
                                <span className="text-green-600">{car.wins}G</span>
                                <span className="text-gray-500">{car.draws}E</span>
                                <span className="text-red-400">{car.losses}P</span>
                            </div>
                        </td>
                        <td className="px-2 py-3 text-center font-black text-lg text-blue-600">
                            {getPoints(car)}
                        </td>
                        <td className="px-2 py-3 text-center text-gray-400 font-medium">{car.matches}</td>
                      </StyledTableRow>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* --- VISTA: T√çTULOS --- */}
          {view === 'titles' && (
            <div className="animate-fade-in">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold text-gray-700">Ranking de T√≠tulos</h2>
                <button onClick={() => resetAllStats(true)} className="text-xs text-red-500 underline">Resetear Todo (Incl. T√≠tulos)</button>
              </div>
              
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                    <tr>
                      <th className="px-2 py-3 text-left w-8">#</th>
                      <th className="px-2 py-3 text-left">Auto</th>
                      <th className="px-2 py-3 text-center bg-gray-100">T√≠tulos</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {sortedTitles.map((car, index) => (
                      <StyledTableRow key={car.id} car={car}>
                        <td className="px-2 py-3 font-bold text-gray-400">
                          {index + 1}
                        </td>
                        <td className="px-2 py-3">
                            <div className="font-medium text-gray-800 flex items-center gap-2">
                                <CarBadge car={car}/>
                                <span>{getFullName(car)}</span>
                            </div>
                        </td>
                        <td className="px-2 py-3 text-center font-black text-lg text-yellow-600">
                            <div className="flex items-center justify-center">
                                {car.titles} <Crown size={18} className="ml-1"/>
                            </div>
                        </td>
                      </StyledTableRow>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}


          {/* --- VISTA: GARAGE --- */}
          {view === 'garage' && (
            <div className="animate-fade-in">
              <h2 className="text-lg font-semibold text-gray-700 mb-4">Gestionar & Rankear</h2>
              <p className="text-xs text-gray-500 mb-4 bg-yellow-50 p-2 rounded border border-yellow-100">
                Tip: Las estrellas (1 a 4) definen el Nivel inicial para la Copa.
                <br/> **4 Estrellas = M√°s Fuerte (Seed Alto)** / **1 Estrella = M√°s D√©bil (Seed Bajo)**.
                <br/> *Los autos m√°s fuertes obtienen pases directos (BYEs) si es necesario.*
              </p>

              <div className="flex gap-2 mb-6">
                <input 
                  type="text" 
                  value={newCarName}
                  onChange={(e) => setNewCarName(e.target.value)}
                  placeholder="Nuevo auto (ej: Porsche 911)" 
                  className="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500"
                  onKeyPress={(e) => e.key === 'Enter' && addCar()}
                />
                <button onClick={addCar} className="bg-gray-900 text-white p-2 rounded-lg active:scale-95"><Plus size={24} /></button>
              </div>

              <div className="space-y-2">
                {cars.map(car => (
                  <div key={car.id} className="flex flex-col bg-white p-3 rounded-lg border border-gray-200 shadow-sm gap-2">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <CarBadge car={car}/>
                            <span className="font-medium text-gray-700">{getFullName(car)}</span>
                        </div>
                        <button onClick={() => deleteCar(car.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={18} /></button>
                    </div>
                    
                    {/* Ranking Selector */}
                    <div className="flex items-center justify-between border-t pt-2 mt-1">
                        <span className="text-xs text-gray-400 uppercase font-bold">Nivel (Seed)</span>
                        <div className="flex gap-1">
                            {/* El Tier va de 1 (D√©bil) a 4 (Fuerte) */}
                            {[1, 2, 3, 4].map((star) => (
                                <button 
                                    key={star}
                                    onClick={() => updateTier(car.id, star)}
                                    className={`p-1 rounded ${car.tier >= star ? 'text-yellow-400' : 'text-gray-200'}`}
                                >
                                    <Star size={16} fill={car.tier >= star ? "currentColor" : "none"} />
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* Color Selector */}
                    <div className="flex items-center justify-between border-t pt-2 mt-1">
                        <span className="text-xs text-gray-400 uppercase font-bold">Color</span>
                        <input
                            type="color"
                            value={car.color}
                            onChange={(e) => updateCarColor(car.id, e.target.value)}
                            className="w-10 h-6 p-0 border-none rounded-md cursor-pointer overflow-hidden"
                            style={{ backgroundColor: car.color, border: '1px solid #ccc' }}
                        />
                    </div>

                  </div>
                ))}
              </div>
            </div>
          )}

        </main>

        <nav className="bg-white border-t border-gray-200 flex justify-between sticky bottom-0 z-20">
          <TabButton id="garage" label="Garage" icon={Car} />
          <TabButton id="arena" label="Carreras" icon={Swords} />
          <TabButton id="ranking" label="Tabla" icon={Award} />
          <TabButton id="titles" label="T√≠tulos" icon={Crown} />
        </nav>

      </div>
    </div>
  );
}

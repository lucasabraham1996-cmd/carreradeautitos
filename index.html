<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MoonRacers Online</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap');
        
        body {
            font-family: 'Noto Sans', sans-serif;
            margin: 0;
            overflow: hidden;
            background-color: #020617;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Animaciones */
        @keyframes shine {
            0% { left: -100%; opacity: 0; }
            50% { opacity: 0.5; }
            100% { left: 200%; opacity: 0; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-shine { animation: shine 2s infinite linear; }
        .animate-bounce-in { animation: bounceIn 0.2s cubic-bezier(0.215, 0.610, 0.355, 1.000) both; }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
        
        /* Scrollbar oculta pero funcional */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Estilos móviles */
        .mobile-height { height: 100dvh; } /* Dynamic Viewport Height para móviles */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useContext, createContext } = React;

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDp-TcQVG08gfM6-7BPvJsMFVTf-wQPMQ8",
            authDomain: "carreradeautitos.firebaseapp.com",
            projectId: "carreradeautitos",
            storageBucket: "carreradeautitos.firebasestorage.app",
            messagingSenderId: "356892591118",
            appId: "1:356892591118:web:399d2b9ee5bbcfdbe1285f",
            measurementId: "G-6E06MR06G9"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- COMPONENTES UI GLOBALES ---
        
        // Iconos
        const Icon = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Trophy = (props) => <Icon {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" /></Icon>;
        const TimerIcon = (props) => <Icon {...props}><line x1="10" x2="14" y1="2" y2="2" /><line x1="12" x2="15" y1="14" y2="11" /><circle cx="12" cy="14" r="8" /></Icon>;
        const CarIcon = (props) => <Icon {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" /><circle cx="7" cy="17" r="2" /><circle cx="17" cy="17" r="2" /></Icon>;
        const Users = (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></Icon>;
        const Plus = (props) => <Icon {...props}><path d="M5 12h14" /><path d="M12 5v14" /></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></Icon>;
        const Edit3 = (props) => <Icon {...props}><path d="M12 20h9" /><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z" /></Icon>;
        const ChevronLeft = (props) => <Icon {...props}><path d="m15 18-6-6 6-6" /></Icon>;
        const ChevronRight = (props) => <Icon {...props}><path d="m9 18 6-6-6-6" /></Icon>;
        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3" /></Icon>;
        const Pause = (props) => <Icon {...props}><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></Icon>;
        const Target = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="6" /><circle cx="12" cy="12" r="2" /></Icon>;
        const ChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6" /></Icon>;
        const SaveIcon = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const ListCheck = (props) => <Icon {...props}><path d="M16 6h6"/><path d="M16 12h6"/><path d="M16 18h6"/><path d="M3 6h6"/><path d="M3 12h6"/><path d="M3 18h6"/></Icon>;
        const MousePointerClick = (props) => <Icon {...props}><path d="m9 9 5 12 1.8-5.2L21 14Z"/><path d="M7.2 2.2 8 5.1"/><path d="m5.1 8-2.9-.8"/><path d="M14 4.1 12 6"/><path d="m6 12-1.9 2"/></Icon>;
        const Medal = (props) => <Icon {...props}><path d="M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15"/><path d="M11 12 5.12 2.2"/><path d="m13 12 5.88-9.8"/><path d="M8 7h8"/><circle cx="12" cy="17" r="5"/><path d="M12 18v-2h-.5"/></Icon>;
        const BarChart = (props) => <Icon {...props}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></Icon>;
        const History = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></Icon>;
        const ArrowLeft = (props) => <Icon {...props}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></Icon>;

        // --- SISTEMAS DE MODAL Y TOAST ---
        
        // Contexto para Toasts (Notificaciones)
        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toast, setToast] = useState(null);
            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 3000);
            };
            return (
                <ToastContext.Provider value={showToast}>
                    {children}
                    {toast && (
                        <div className="fixed bottom-20 md:bottom-10 left-1/2 -translate-x-1/2 z-[100] animate-slide-up">
                            <div className={`px-6 py-3 rounded-full font-bold shadow-2xl border ${toast.type === 'error' ? 'bg-red-900/90 border-red-500 text-white' : 'bg-green-900/90 border-green-500 text-white'} backdrop-blur-md`}>
                                {toast.msg}
                            </div>
                        </div>
                    )}
                </ToastContext.Provider>
            );
        };
        const useToast = () => useContext(ToastContext);

        // Contexto para Modales (Confirmaciones)
        const ModalContext = createContext();
        const ModalProvider = ({ children }) => {
            const [modal, setModal] = useState(null); // { title, msg, onConfirm }

            const showConfirm = (title, msg, onConfirm) => {
                setModal({ title, msg, onConfirm });
            };

            const close = () => setModal(null);

            return (
                <ModalContext.Provider value={{ showConfirm }}>
                    {children}
                    {modal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fadeIn">
                            <div className="bg-slate-900 border border-white/10 w-full max-w-sm p-6 rounded-2xl shadow-2xl animate-bounce-in relative">
                                <h3 className="text-xl text-white font-bold mb-2 font-black italic uppercase tracking-tighter">{modal.title}</h3>
                                <p className="text-slate-300 mb-6 text-sm">{modal.msg}</p>
                                <div className="flex justify-end gap-3">
                                    <button onClick={close} className="px-4 py-2 text-slate-400 hover:text-white font-bold text-sm">CANCELAR</button>
                                    <button onClick={() => { modal.onConfirm(); close(); }} className="px-6 py-2 bg-red-600 hover:bg-red-500 text-white rounded-xl font-bold shadow-lg shadow-red-600/20 text-sm">CONFIRMAR</button>
                                </div>
                            </div>
                        </div>
                    )}
                </ModalContext.Provider>
            );
        };
        const useModal = () => useContext(ModalContext);

        // --- UTILIDADES ---
        const formatTime = (time) => {
            const minutes = Math.floor(time / 60000);
            const seconds = Math.floor((time % 60000) / 1000);
            const milliseconds = Math.floor((time % 1000) / 10);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${milliseconds.toString().padStart(2, '0')}`;
        };

        const getCarGradient = (color) => `linear-gradient(135deg, ${color}20 0%, ${color}80 100%)`;
        const getCarBorder = (color) => `1px solid ${color}80`;
        const getCarShadow = (color) => `0 0 20px ${color}40`;
        const headerFontClass = "font-black italic tracking-tighter uppercase";
        
        const getCarInitials = (car) => {
            if (!car) return "";
            const brandInit = car.brand ? car.brand.substring(0, 3).toUpperCase() : "UNK";
            const modelInit = car.model ? car.model.split(" ")[0].toUpperCase() : "CAR";
            return `${brandInit} ${modelInit}`; 
        };

        // --- COMPONENTES PRINCIPALES ---

        // 1. GARAJE
        const Garage = ({ cars, loading }) => {
            const [activeIndex, setActiveIndex] = useState(0);
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState({ model: '', brand: '', color: '#ffffff', logo: '' });
            const [showForm, setShowForm] = useState(false);
            const showToast = useToast();
            const { showConfirm } = useModal();

            const nextCar = () => setActiveIndex((prev) => (prev + 1) % cars.length);
            const prevCar = () => setActiveIndex((prev) => (prev - 1 + cars.length) % cars.length);

            const handleSave = async () => {
                if(!formData.brand || !formData.model) return showToast("Falta Marca o Modelo", "error");
                try {
                    if (isEditing) await db.collection('cars').doc(cars[activeIndex].id).update(formData);
                    else {
                        await db.collection('cars').add(formData);
                        setActiveIndex(cars.length);
                    }
                    setShowForm(false); setIsEditing(false); setFormData({ model: '', brand: '', color: '#ffffff', logo: '' });
                    showToast("Auto guardado");
                } catch (error) { showToast("Error al guardar", "error"); }
            };

            const startEdit = () => {
                if (cars.length === 0) return;
                setFormData(cars[activeIndex]); setIsEditing(true); setShowForm(true);
            };

            const deleteCar = () => {
                if (cars.length <= 1) return showToast("Debe haber al menos un auto", "error");
                showConfirm("Eliminar Auto", "¿Estás seguro de que quieres eliminar este auto permanentemente?", async () => {
                    await db.collection('cars').doc(cars[activeIndex].id).delete();
                    setActiveIndex(0);
                    showToast("Auto eliminado");
                });
            };

            if (loading) return <div className="h-full flex items-center justify-center text-white">Cargando motores...</div>;

            if (cars.length === 0) return <div className="h-full flex flex-col items-center justify-center text-white"><button onClick={() => setShowForm(true)} className="px-8 py-4 bg-blue-600 rounded-xl font-bold">CREAR PRIMER AUTO</button>{showForm && <CarForm formData={formData} setFormData={setFormData} onSave={handleSave} onClose={() => setShowForm(false)} title="Nuevo Auto" />}</div>;

            const currentCar = cars[activeIndex];

            return (
                <div className="flex flex-col items-center justify-start md:justify-center h-full w-full relative overflow-hidden pt-4 md:pt-0">
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-blue-500/10 rounded-full blur-[120px] pointer-events-none"></div>
                    
                    {/* Tarjeta Central Responsiva */}
                    <div className="relative w-full max-w-md md:max-w-4xl h-[60vh] md:h-[500px] flex items-center justify-center perspective-1000 mb-4 md:mb-0">
                        {/* Botones Navegación */}
                        <div className="absolute inset-0 flex items-center justify-between px-2 md:px-12 pointer-events-none z-30 w-full">
                            <button onClick={prevCar} className="pointer-events-auto p-3 bg-white/5 backdrop-blur-md rounded-full border border-white/20 active:scale-90 transition-all"><ChevronLeft className="w-6 h-6 md:w-8 md:h-8 text-white" /></button>
                            <button onClick={nextCar} className="pointer-events-auto p-3 bg-white/5 backdrop-blur-md rounded-full border border-white/20 active:scale-90 transition-all"><ChevronRight className="w-6 h-6 md:w-8 md:h-8 text-white" /></button>
                        </div>
                        
                        <div className="w-[85vw] md:w-96 h-full transition-all duration-300 relative z-20">
                            <div className="w-full h-full backdrop-blur-xl border rounded-3xl flex flex-col overflow-hidden relative shadow-2xl" style={{ background: getCarGradient(currentCar.color), borderColor: `${currentCar.color}60` }}>
                                <div className="h-1/3 bg-gradient-to-b from-black/40 to-transparent absolute top-0 w-full" />
                                <div className="relative z-10 flex justify-center items-center mt-8 md:mt-12 mb-4 h-32 md:h-40">
                                    {currentCar.logo ? <img src={currentCar.logo} className="h-full w-full object-contain p-4 drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]" /> : <CarIcon className="w-24 h-24 text-white/50" />}
                                </div>
                                <div className="flex-1 flex flex-col items-center justify-end pb-8 md:pb-12 z-10 text-center px-4">
                                    <h2 className={`text-3xl md:text-4xl text-white mb-2 drop-shadow-lg ${headerFontClass}`}>{currentCar.brand}</h2>
                                    <h3 className="text-lg md:text-xl text-blue-100 font-medium tracking-widest uppercase opacity-90">{currentCar.model}</h3>
                                    <div className="flex items-center gap-2 mt-4 md:mt-6 bg-black/40 px-4 py-2 rounded-full border border-white/10 backdrop-blur-md">
                                        <div className="w-5 h-5 rounded-full border border-white/50 shadow-[0_0_10px_currentColor]" style={{ backgroundColor: currentCar.color, color: currentCar.color }} />
                                        <span className="text-[10px] text-gray-300 uppercase tracking-widest font-bold">Pintura</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Controles */}
                    <div className="flex gap-4 md:mt-8 z-50 relative pb-20 md:pb-0">
                        <button onClick={() => { setIsEditing(false); setFormData({ model: '', brand: '', color: '#ffffff', logo: '' }); setShowForm(true); }} className="flex items-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm"><Plus size={18} /> NUEVO</button>
                        <button onClick={startEdit} className="flex items-center gap-2 px-4 py-3 bg-slate-700/50 text-white border border-white/10 rounded-xl text-sm"><Edit3 size={18} /> EDITAR</button>
                        <button onClick={deleteCar} className="flex items-center gap-2 px-4 py-3 bg-red-900/40 text-red-200 border border-red-500/20 rounded-xl text-sm"><Trash2 size={18} /> BORRAR</button>
                    </div>

                    {showForm && <CarForm formData={formData} setFormData={setFormData} onSave={handleSave} onClose={() => setShowForm(false)} title={isEditing ? 'Editar Auto' : 'Nuevo Auto'} />}
                </div>
            );
        };

        // Componente Auxiliar Formulario Auto
        const CarForm = ({ formData, setFormData, onSave, onClose, title }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-fadeIn">
                <div className="bg-slate-900 border border-blue-500/30 w-full max-w-md p-6 rounded-2xl shadow-2xl relative animate-bounce-in">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X /></button>
                    <h3 className={`text-2xl text-white mb-6 ${headerFontClass}`}>{title}</h3>
                    <div className="space-y-4">
                        <input type="text" value={formData.brand} onChange={e => setFormData({...formData, brand: e.target.value})} className="w-full bg-slate-800 text-white border border-slate-700 rounded-lg p-3" placeholder="Marca (Ej. Ferrari)"/>
                        <input type="text" value={formData.model} onChange={e => setFormData({...formData, model: e.target.value})} className="w-full bg-slate-800 text-white border border-slate-700 rounded-lg p-3" placeholder="Modelo (Ej. F40)"/>
                        <input type="text" value={formData.logo} onChange={e => setFormData({...formData, logo: e.target.value})} className="w-full bg-slate-800 text-white border border-slate-700 rounded-lg p-3" placeholder="URL del Logo (Opcional)"/>
                        <div className="flex items-center gap-4">
                            <span className="text-white text-sm">Color:</span>
                            <input type="color" value={formData.color} onChange={e => setFormData({...formData, color: e.target.value})} className="flex-1 h-10 rounded cursor-pointer bg-transparent"/>
                        </div>
                        <button onClick={onSave} className="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl mt-4 shadow-lg shadow-blue-600/20">GUARDAR</button>
                    </div>
                </div>
            </div>
        );

        // 2. TORNEO (Crono)
        const TimeTrial = ({ cars }) => {
            const [results, setResults] = useState([]);
            const [selectedCarId, setSelectedCarId] = useState('');
            const [timer, setTimer] = useState({ running: false, start: 0, elapsed: 0 });
            const intervalRef = useRef(null);
            const showToast = useToast();
            const { showConfirm } = useModal();

            useEffect(() => {
                const unsubscribe = db.collection('race_results').onSnapshot(snap => {
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setResults(data.sort((a, b) => a.time - b.time));
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (timer.running) { intervalRef.current = setInterval(() => { setTimer(t => ({ ...t, elapsed: Date.now() - t.start })); }, 10); } 
                else { clearInterval(intervalRef.current); }
                return () => clearInterval(intervalRef.current);
            }, [timer.running]);

            const startTimer = () => { if (!selectedCarId) return showToast("Elige un auto primero", "error"); setTimer({ running: true, start: Date.now() - timer.elapsed, elapsed: timer.elapsed }); };
            const stopTimer = () => setTimer(prev => ({ ...prev, running: false }));
            const resetTimer = () => { setTimer({ running: false, start: 0, elapsed: 0 }); };

            const saveTime = async () => {
                if (timer.elapsed === 0) return;
                const car = cars.find(c => c.id === selectedCarId);
                if (!car) return;
                try {
                    await db.collection('race_results').add({
                        carId: car.id, brand: car.brand, model: car.model, color: car.color, logo: car.logo, time: timer.elapsed, timestamp: Date.now()
                    });
                    resetTimer(); showToast("¡Tiempo registrado!");
                } catch(e) { showToast(e.message, "error"); }
            };

            const deleteResult = (id) => { 
                showConfirm("Borrar Tiempo", "¿Borrar este registro de tiempo?", async () => {
                    await db.collection('race_results').doc(id).delete();
                });
            };
            
            // REINICIAR TEMPORADA MEJORADO
            const resetTournament = () => {
                showConfirm("Reiniciar Temporada", "Se borrarán TODOS los tiempos registrados. ¿Estás seguro?", async () => {
                    try {
                        const snap = await db.collection('race_results').get();
                        const batch = db.batch();
                        snap.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        showToast("Temporada reiniciada correctamente");
                    } catch (error) {
                        try {
                            const snap = await db.collection('race_results').get();
                            snap.forEach(doc => doc.ref.delete());
                        } catch(e) { console.error(e); }
                    }
                });
            };

            return (
                <div className="w-full h-full p-4 md:p-6 flex flex-col md:flex-row gap-6 overflow-y-auto no-scrollbar pb-24 md:pb-6">
                    {/* Panel Izquierdo: Cronómetro */}
                    <div className="w-full md:w-1/3 flex flex-col gap-4">
                        <div className="bg-slate-900/80 p-6 rounded-3xl border border-white/10 backdrop-blur-xl shadow-2xl">
                            <h2 className={`text-xl md:text-2xl text-white mb-6 flex items-center gap-2 ${headerFontClass}`}><TimerIcon className="text-blue-400" /> Puesto de Control</h2>
                            <div className="mb-6 relative">
                                <label className="text-xs text-blue-300 font-bold uppercase tracking-wider mb-2 block">Piloto</label>
                                <select value={selectedCarId} onChange={(e) => { setSelectedCarId(e.target.value); resetTimer(); }} className="w-full bg-slate-800 text-white text-lg font-bold rounded-xl px-4 py-4 outline-none border border-slate-700 focus:border-blue-500 appearance-none">
                                    <option value="">-- Seleccionar Auto --</option>{cars.map(c => <option key={c.id} value={c.id}>{c.brand} - {c.model}</option>)}
                                </select>
                                <div className="absolute right-4 top-10 pointer-events-none text-slate-400"><ChevronDown /></div>
                            </div>
                            <div className="bg-black/40 rounded-2xl p-6 text-center border border-white/10 mb-6">
                                <div className={`text-5xl md:text-6xl font-mono tracking-tighter ${timer.running ? 'text-yellow-400' : 'text-white'}`}>{formatTime(timer.elapsed)}</div>
                            </div>
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                {!timer.running ? ( <button onClick={startTimer} className="bg-green-600 text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg active:scale-95"><Play fill="currentColor" /> INICIAR</button> ) : ( <button onClick={stopTimer} className="bg-yellow-600 text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg active:scale-95 animate-pulse"><Pause fill="currentColor" /> PAUSAR</button> )}
                                <button onClick={resetTimer} className="bg-slate-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95"><RotateCcw /> RESET</button>
                            </div>
                            <button onClick={saveTime} disabled={timer.elapsed === 0 || timer.running} className={`w-full py-4 rounded-xl font-black text-lg flex items-center justify-center gap-2 ${timer.elapsed > 0 && !timer.running ? 'bg-blue-600 text-white shadow-lg shadow-blue-600/30' : 'bg-slate-800 text-slate-600'}`}><SaveIcon /> REGISTRAR</button>
                        </div>
                        {results.length > 0 && <button onClick={resetTournament} className="w-full py-3 bg-red-900/30 hover:bg-red-900/50 text-red-200 border border-red-500/20 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all"><Trash2 size={16}/> REINICIAR TEMPORADA</button>}
                    </div>

                    {/* Panel Derecho: Tabla */}
                    <div className="flex-1 bg-slate-900/60 rounded-3xl overflow-hidden border border-white/10 backdrop-blur-xl flex flex-col shadow-2xl min-h-[400px]">
                        <div className="bg-[#1e1b4b] p-4 md:p-6 flex items-center justify-between border-b border-white/10">
                            <div className="flex items-center gap-4">
                                <div className="bg-gradient-to-tr from-cyan-400 to-blue-600 p-2 rounded-lg shadow-lg"><TimerIcon className="text-white w-5 h-5" /></div>
                                <div><h2 className={`text-xl md:text-2xl text-white leading-none uppercase tracking-tighter ${headerFontClass}`}>Torneo Oficial</h2></div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto no-scrollbar p-2 md:p-4">
                            <table className="w-full text-left border-collapse border-spacing-y-2 border-separate">
                                <thead className="text-slate-400 text-[10px] uppercase font-bold tracking-widest sticky top-0 bg-slate-900/90 backdrop-blur z-20"><tr><th className="pb-4 pl-4 text-center">#</th><th className="pb-4">Corredor</th><th className="pb-4 text-right">Tiempo</th><th className="pb-4 pr-4 text-center">X</th></tr></thead>
                                <tbody className="space-y-2">
                                    {results.map((entry, idx) => (
                                        <tr key={entry.id} className="relative group">
                                            <td colSpan="4" className="p-0">
                                                <div className="flex items-center p-2 md:p-3 rounded-xl relative overflow-hidden mb-2" style={{ background: getCarGradient(entry.color), border: getCarBorder(entry.color) }}>
                                                    <div className="w-10 text-center z-10"><div className={`w-6 h-6 rounded flex items-center justify-center font-black text-xs mx-auto ${idx < 3 ? 'bg-white text-black' : 'bg-black/30 text-white'}`}>{idx + 1}</div></div>
                                                    <div className="flex-1 flex items-center gap-3 z-10 pl-2">
                                                        <div className="w-8 h-8 bg-white/10 rounded-full p-0.5 border border-white/20">{entry.logo && <img src={entry.logo} className="w-full h-full object-contain" />}</div>
                                                        <div><div className={`text-white text-sm md:text-lg leading-none ${headerFontClass}`}>{entry.brand}</div><div className="text-[10px] md:text-xs text-blue-100 opacity-80 uppercase tracking-wider">{entry.model}</div></div>
                                                    </div>
                                                    <div className="text-right px-2 z-10"><div className={`font-mono font-bold text-sm md:text-xl ${idx < 3 ? 'text-yellow-300' : 'text-white'}`}>{formatTime(entry.time)}</div></div>
                                                    <div className="w-10 text-center z-20"><button onClick={() => deleteResult(entry.id)} className="p-2 text-white/50 hover:text-red-400 relative z-50"><X size={16}/></button></div>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {results.length === 0 && <tr><td colSpan="4" className="py-20 text-center text-slate-500 italic">No hay tiempos registrados.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. COPA (Bracket)
        const Tournament = ({ cars, onSaveToPalmares }) => {
            const [bracket, setBracket] = useState(null);
            const [manualSelection, setManualSelection] = useState(false);
            const [selectedForCup, setSelectedForCup] = useState([]);
            const showToast = useToast();
            const { showConfirm } = useModal();

            useEffect(() => {
                const unsubscribe = db.collection('active_tournament').doc('current').onSnapshot(doc => {
                    setBracket(doc.exists ? doc.data() : null);
                });
                return () => unsubscribe();
            }, []);

            // Lógica corregida para Cargar desde Torneo
            const loadFromTorneo = async () => {
                try {
                    const snap = await db.collection('race_results').orderBy('time', 'asc').get();
                    const results = snap.docs.map(d => ({...d.data()}));
                    
                    // Filtrar únicos (primer mejor tiempo de cada auto)
                    const uniqueCars = []; 
                    const seenIds = new Set();
                    for (const r of results) { 
                        if (!seenIds.has(r.carId)) { 
                            uniqueCars.push(r); 
                            seenIds.add(r.carId); 
                        } 
                        if (uniqueCars.length === 16) break; 
                    }
                    
                    if (uniqueCars.length < 16) return showToast(`Faltan autos (${uniqueCars.length}/16). Corre más carreras.`, "error");
                    
                    // Mezclar emparejamientos: 1vs16, 2vs15, etc.
                    const round1 = [];
                    for(let i=0; i<8; i++) { 
                        round1.push({ p1: uniqueCars[i], p2: uniqueCars[15-i], winner: null }); 
                    }
                    
                    createBracket(round1);
                    showToast("Copa generada desde Torneo");
                } catch(e) { showToast("Error: " + e.message, "error"); }
            };

            const startManualCup = () => {
                if (selectedForCup.length !== 16) return showToast("Selecciona 16 autos", "error");
                const shuffled = [...selectedForCup].sort(() => 0.5 - Math.random()); // Aleatorio
                const round1 = [];
                for(let i=0; i<8; i+=1) { 
                    round1.push({ p1: shuffled[i], p2: shuffled[15-i], winner: null }); 
                }
                createBracket(round1);
                setManualSelection(false); setSelectedForCup([]);
                showToast("Copa Manual Iniciada");
            };

            const createBracket = (round1Data) => {
                const bracketData = { 
                    round1: round1Data, 
                    round2: Array(4).fill({ p1: null, p2: null, winner: null }), 
                    round3: Array(2).fill({ p1: null, p2: null, winner: null }), 
                    round4: Array(1).fill({ p1: null, p2: null, winner: null }), 
                    champion: null 
                };
                db.collection('active_tournament').doc('current').set(bracketData);
            };

            const advanceWinner = (roundKey, matchIndex, winner) => {
                if (!bracket) return;
                const newBracket = { ...bracket };
                const match = newBracket[roundKey][matchIndex];
                const loser = (winner.carId === match.p1.carId) ? match.p2 : match.p1;

                newBracket[roundKey][matchIndex] = { ...match, winner };
                
                let nextRoundKey = '', nextMatchIndex = Math.floor(matchIndex / 2), playerSlot = matchIndex % 2 === 0 ? 'p1' : 'p2';
                
                if (roundKey === 'round1') nextRoundKey = 'round2';
                else if (roundKey === 'round2') nextRoundKey = 'round3';
                else if (roundKey === 'round3') nextRoundKey = 'round4';
                else if (roundKey === 'round4') { 
                    newBracket.champion = winner;
                    db.collection('active_tournament').doc('current').set(newBracket);
                    // Guardar automáticamente
                    const dateStr = new Date().toLocaleDateString();
                    db.collection('hall_of_fame').add({ carId: winner.carId, brand: winner.brand, model: winner.model, logo: winner.logo, color: winner.color, title: `Campeón Copa ${dateStr}`, position: 'champion', timestamp: Date.now() });
                    if (loser) db.collection('hall_of_fame').add({ carId: loser.carId, brand: loser.brand, model: loser.model, logo: loser.logo, color: loser.color, title: `Subcampeón Copa ${dateStr}`, position: 'runner-up', timestamp: Date.now() });
                    showToast(`¡${winner.brand} Campeón!`);
                    return;
                }
                
                if (nextRoundKey) { 
                    const nextMatch = { ...newBracket[nextRoundKey][nextMatchIndex] }; 
                    nextMatch[playerSlot] = winner; 
                    newBracket[nextRoundKey][nextMatchIndex] = nextMatch; 
                }
                db.collection('active_tournament').doc('current').set(newBracket);
            };

            const BracketMatch = ({ match, round, index }) => (
                <div className="flex flex-col gap-1 bg-slate-900/50 p-1 md:p-2 rounded-lg border border-white/10 mb-2 md:mb-4 w-32 md:w-40 backdrop-blur-sm relative shrink-0">
                    {[match.p1, match.p2].map((car, idx) => {
                        const isWinner = match.winner?.carId === car?.carId;
                        return (
                            <button key={idx} onClick={(e) => { e.stopPropagation(); if (car && !match.winner) advanceWinner(round, index, car); }} 
                                className={`h-8 md:h-10 flex items-center gap-2 px-2 rounded cursor-pointer border relative overflow-hidden w-full ${isWinner ? 'text-white scale-105 z-10' : 'text-gray-400 hover:bg-white/10'} ${!car ? 'opacity-30 pointer-events-none' : ''}`} 
                                style={{ background: car ? (isWinner ? getCarGradient(car.color) : `linear-gradient(90deg, ${car.color}10, transparent)`) : 'transparent', borderColor: car ? `${car.color}60` : 'transparent' }}>
                                {car ? ( <><div className="w-5 h-5 rounded-full bg-white/10 flex items-center justify-center shrink-0 border border-white/20">{car.logo && <img src={car.logo} className="w-full h-full object-contain p-0.5" />}</div><span className={`text-[9px] md:text-[10px] truncate font-bold uppercase`}>{getCarInitials(car)}</span>{isWinner && <Trophy className="ml-auto text-yellow-400 w-3 h-3" />}</> ) : <span className="text-[10px]">...</span>}
                            </button>
                    )})}
                </div>
            );
            
            // UI SELECCIÓN MANUAL MEJORADA
            if (manualSelection) {
                return (
                    <div className="w-full h-full p-4 md:p-8 flex flex-col bg-slate-950 overflow-hidden">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className={`text-xl md:text-3xl text-white ${headerFontClass}`}>Elige 16 Autos</h2>
                            <div className="flex gap-2 items-center">
                                <span className={`text-sm md:text-xl font-mono px-3 py-1 rounded-lg border ${selectedForCup.length === 16 ? 'border-green-500 text-green-400' : 'border-white/10 text-white'}`}>{selectedForCup.length}/16</span>
                                <button onClick={() => setManualSelection(false)} className="text-slate-400 text-sm px-2">Cancelar</button>
                                <button onClick={startManualCup} disabled={selectedForCup.length !== 16} className={`px-4 py-2 rounded-xl font-bold text-sm ${selectedForCup.length === 16 ? 'bg-green-600 text-white' : 'bg-slate-800 text-slate-500'}`}>JUGAR</button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto no-scrollbar pb-24">
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                                {cars.map(car => {
                                    const isSelected = selectedForCup.find(c => c.id === car.id);
                                    return (
                                        <div key={car.id} onClick={() => {
                                            if (isSelected) setSelectedForCup(prev => prev.filter(c => c.id !== car.id));
                                            else { if (selectedForCup.length >= 16) return showToast("Máximo 16", "error"); setSelectedForCup(prev => [...prev, car]); }
                                        }} className={`cursor-pointer rounded-2xl p-4 border-2 transition-all relative aspect-square flex flex-col items-center justify-center bg-slate-900/40 ${isSelected ? 'border-green-500 bg-green-900/20' : 'border-white/5 hover:border-white/20'}`}>
                                            <div className="w-full h-1/2 flex items-center justify-center mb-2">{car.logo ? <img src={car.logo} className="max-h-full max-w-full object-contain drop-shadow-md" /> : <CarIcon className="w-10 h-10 text-white/20"/>}</div>
                                            <div className="text-center w-full">
                                                <div className="text-[10px] text-blue-300 uppercase font-black tracking-widest truncate">{car.brand}</div>
                                                <div className="text-sm md:text-base text-white font-bold truncate">{car.model}</div>
                                            </div>
                                            {isSelected && <div className="absolute top-2 right-2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-black font-bold text-xs shadow-lg">✓</div>}
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            if (!bracket) {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-4">
                        <Trophy className="w-24 h-24 md:w-32 md:h-32 text-slate-700 mb-6" />
                        <h2 className="text-3xl md:text-4xl text-white font-black uppercase italic mb-8 text-center">Copa MoonRacers</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl">
                            <button className="bg-slate-900 border border-white/10 p-6 md:p-8 rounded-3xl hover:border-blue-500/50 flex flex-col items-center text-center group" onClick={loadFromTorneo}>
                                <ListCheck className="w-12 h-12 text-blue-400 mb-4 group-hover:scale-110 transition-transform"/>
                                <h3 className="text-xl text-white font-bold">Cargar Clasificados</h3>
                                <p className="text-slate-400 text-xs mt-2">Usar los 16 mejores tiempos del Torneo.</p>
                            </button>
                            <button className="bg-slate-900 border border-white/10 p-6 md:p-8 rounded-3xl hover:border-green-500/50 flex flex-col items-center text-center group" onClick={() => setManualSelection(true)}>
                                <MousePointerClick className="w-12 h-12 text-green-400 mb-4 group-hover:scale-110 transition-transform"/>
                                <h3 className="text-xl text-white font-bold">Selección Manual</h3>
                                <p className="text-slate-400 text-xs mt-2">Elegir 16 autos a dedo.</p>
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full h-full overflow-x-auto overflow-y-hidden p-4 md:p-8 relative bg-slate-950 flex flex-col">
                    <div className="flex justify-between items-center mb-4 px-4 min-w-[300px]">
                        <h3 className="text-white font-bold uppercase text-sm">Cuadro de Eliminación</h3>
                        <button onClick={() => { showConfirm("Reiniciar Copa", "¿Estás seguro? Se perderá el progreso actual.", () => db.collection('active_tournament').doc('current').delete()); }} className="text-red-400 text-xs border border-red-500/30 px-3 py-1 rounded hover:bg-red-900/20">Reiniciar</button>
                    </div>
                    {/* Vista Bracket: Scroll Horizontal en Móvil */}
                    <div className="flex justify-start md:justify-center min-w-[800px] md:min-w-full h-full items-center pl-4 pb-20">
                        <div className="flex flex-col justify-around h-full mr-8"><h3 className="text-center text-blue-400 text-[10px] uppercase mb-2 tracking-widest">Octavos</h3>{bracket.round1.map((m, i) => <BracketMatch key={i} match={m} round="round1" index={i} />)}</div>
                        <div className="flex flex-col justify-around h-[80%] mr-8 relative"><div className="absolute left-[-1rem] top-0 bottom-0 w-px bg-white/5"></div><h3 className="text-center text-blue-400 text-[10px] uppercase mb-2 tracking-widest">Cuartos</h3>{bracket.round2.map((m, i) => <BracketMatch key={i} match={m} round="round2" index={i} />)}</div>
                        <div className="flex flex-col justify-around h-[60%] mr-8 relative"><div className="absolute left-[-1rem] top-0 bottom-0 w-px bg-white/5"></div><h3 className="text-center text-blue-400 text-[10px] uppercase mb-2 tracking-widest">Semi</h3>{bracket.round3.map((m, i) => <BracketMatch key={i} match={m} round="round3" index={i} />)}</div>
                        <div className="flex flex-col justify-center h-full relative"><div className="absolute left-[-1rem] top-0 bottom-0 w-px bg-white/5"></div><h3 className="text-center text-yellow-400 text-xs font-bold uppercase mb-4 tracking-widest">FINAL</h3><BracketMatch match={bracket.round4[0]} round="round4" index={0} /></div>
                        
                        {/* Campeón Display */}
                        <div className="flex flex-col justify-center items-center h-full w-48 md:w-64 pl-8 border-l border-white/5 ml-4">
                            {bracket.champion ? (
                                <div className="flex flex-col items-center animate-bounce-in text-center p-2">
                                    <Trophy className="w-16 h-16 md:w-24 md:h-24 text-yellow-400 drop-shadow-[0_0_20px_rgba(250,204,21,0.8)] mb-4" />
                                    <h2 className={`text-xl md:text-3xl text-white text-center mb-1 ${headerFontClass}`}>{bracket.champion.brand}</h2>
                                    <h3 className="text-sm md:text-xl text-blue-300 text-center uppercase tracking-widest">{bracket.champion.model}</h3>
                                    <button onClick={() => onSaveToPalmares(bracket.champion)} className="mt-6 px-4 py-2 bg-slate-800 text-white text-xs rounded-lg border border-white/20">Agregar Otro Título</button>
                                </div>
                            ) : <div className="w-24 h-24 rounded-full border-2 border-dashed border-white/10 flex items-center justify-center"><Trophy className="w-8 h-8 text-white/10" /></div>}
                        </div>
                    </div>
                </div>
            );
        };

        // 4. PALMARÉS (Historial + Edición + Ranking Mejorado)
        const Palmares = ({ cars }) => {
            const [honors, setHonors] = useState([]);
            const [viewMode, setViewMode] = useState('ranking'); // Default to ranking
            const [editForm, setEditForm] = useState({ id: null, carId: '', title: '' });
            const [selectedCarHistory, setSelectedCarHistory] = useState(null); // Nuevo estado para detalle
            const showToast = useToast();
            const { showConfirm } = useModal();

            useEffect(() => {
                const unsubscribe = db.collection('hall_of_fame').orderBy('timestamp', 'desc').onSnapshot(snap => {
                    setHonors(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsubscribe();
            }, []);

            const saveHonor = async () => {
                if (!editForm.carId || !editForm.title) return showToast("Completa los datos", "error");
                const car = cars.find(c => c.id === editForm.carId);
                if (!car) return;
                
                const data = {
                    carId: car.id, brand: car.brand, model: car.model, logo: car.logo, color: car.color,
                    title: editForm.title, position: 'champion', timestamp: editForm.id ? Date.now() : Date.now()
                };

                try {
                    if (editForm.id) await db.collection('hall_of_fame').doc(editForm.id).update(data);
                    else await db.collection('hall_of_fame').add(data);
                    
                    setEditForm({ id: null, carId: '', title: '' });
                    showToast("Título guardado");
                } catch(e) { showToast("Error", "error"); }
            };

            const deleteHonor = (e, id) => { 
                e.stopPropagation(); 
                showConfirm("Eliminar Título", "¿Borrar este título del historial?", async () => {
                    await db.collection('hall_of_fame').doc(id).delete(); 
                });
            };

            // Lógica Ranking: Agrupar y ordenar por campeonatos (luego subs)
            const rankingData = useMemo(() => {
                const stats = {};
                honors.forEach(h => {
                    if (!stats[h.carId]) stats[h.carId] = { car: h, champions: 0, runnerUps: 0, titles: [] };
                    stats[h.carId].titles.push(h); // Guardar historial individual
                    if (h.position === 'champion') stats[h.carId].champions++;
                    if (h.position === 'runner-up') stats[h.carId].runnerUps++;
                });
                return Object.values(stats).sort((a, b) => {
                    if (b.champions !== a.champions) return b.champions - a.champions; // Primero Campeonatos
                    return b.runnerUps - a.runnerUps; // Luego Subcampeonatos
                });
            }, [honors]);

            // Ver detalle de auto
            if (selectedCarHistory) {
                 return (
                    <div className="w-full h-full p-6 flex flex-col items-center justify-start bg-slate-950 overflow-y-auto">
                        <div className="w-full max-w-2xl bg-slate-900/80 p-6 rounded-3xl border border-white/10 backdrop-blur-xl relative">
                            <button onClick={() => setSelectedCarHistory(null)} className="absolute top-6 left-6 text-white hover:text-blue-400 flex items-center gap-2"><ArrowLeft size={20}/> Volver</button>
                            <div className="flex flex-col items-center mt-8">
                                <div className="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center border border-white/10 mb-4">{selectedCarHistory.car.logo && <img src={selectedCarHistory.car.logo} className="w-16 h-16 object-contain"/>}</div>
                                <h2 className={`text-3xl text-white ${headerFontClass}`}>{selectedCarHistory.car.brand}</h2>
                                <h3 className="text-xl text-blue-300 uppercase tracking-widest">{selectedCarHistory.car.model}</h3>
                                <div className="flex gap-4 mt-4">
                                    <div className="px-4 py-2 bg-yellow-600/20 border border-yellow-500/50 rounded-lg text-yellow-400 font-bold text-sm">{selectedCarHistory.champions} Copas</div>
                                    <div className="px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg text-slate-300 font-bold text-sm">{selectedCarHistory.runnerUps} Subcampeonatos</div>
                                </div>
                            </div>
                            <div className="mt-8 space-y-3">
                                {selectedCarHistory.titles.sort((a,b) => b.timestamp - a.timestamp).map(t => (
                                    <div key={t.id} className={`p-4 rounded-xl border flex items-center gap-4 ${t.position === 'champion' ? 'bg-gradient-to-r from-yellow-900/20 to-transparent border-yellow-500/30' : 'bg-slate-800/30 border-slate-700'}`}>
                                        <div className={`p-2 rounded-full ${t.position === 'champion' ? 'bg-yellow-500 text-black' : 'bg-slate-600 text-white'}`}><Trophy size={16}/></div>
                                        <div className="flex-1">
                                            <div className="text-white font-bold">{t.title}</div>
                                            <div className="text-xs text-slate-400">{new Date(t.timestamp).toLocaleDateString()}</div>
                                        </div>
                                        <div className={`text-xs font-bold uppercase tracking-wider ${t.position === 'champion' ? 'text-yellow-400' : 'text-slate-400'}`}>{t.position === 'champion' ? 'CAMPEÓN' : 'SUBCAMPEÓN'}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                 )
            }

            return (
                <div className="w-full h-full p-4 md:p-8 flex flex-col md:flex-row gap-6 overflow-y-auto no-scrollbar pb-24">
                    {/* Formulario Lateral (Gestión Manual) */}
                    <div className="w-full md:w-1/3">
                        <div className="bg-slate-900/80 p-6 rounded-3xl border border-white/10 backdrop-blur-xl shadow-xl sticky top-0">
                            <h2 className={`text-xl text-white mb-4 flex items-center gap-2 ${headerFontClass}`}>{editForm.id ? 'Editar Título' : 'Otorgar Título Manual'}</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs text-blue-300 font-bold uppercase mb-1 block">Auto Campeón</label>
                                    <select value={editForm.carId} onChange={e => setEditForm({...editForm, carId: e.target.value})} className="w-full bg-slate-800 text-white p-3 rounded-xl border border-slate-700 outline-none">
                                        <option value="">-- Seleccionar --</option>{cars.map(c => <option key={c.id} value={c.id}>{c.brand} {c.model}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-blue-300 font-bold uppercase mb-1 block">Nombre Copa / Título</label>
                                    <input type="text" value={editForm.title} onChange={e => setEditForm({...editForm, title: e.target.value})} className="w-full bg-slate-800 text-white p-3 rounded-xl border border-slate-700 outline-none" placeholder="Ej. Copa Verano"/>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={saveHonor} className="flex-1 py-3 bg-yellow-600 text-white font-bold rounded-xl shadow-lg">{editForm.id ? 'ACTUALIZAR' : 'AGREGAR'}</button>
                                    {editForm.id && <button onClick={() => setEditForm({ id: null, carId: '', title: '' })} className="px-4 bg-slate-700 text-white rounded-xl">Cancelar</button>}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Lista / Ranking */}
                    <div className="flex-1 flex flex-col bg-slate-900/50 rounded-3xl overflow-hidden border border-white/5 backdrop-blur-sm min-h-[400px]">
                        <div className="flex border-b border-white/10">
                            <button onClick={() => setViewMode('ranking')} className={`flex-1 py-3 text-center font-bold uppercase text-xs tracking-wider flex items-center justify-center gap-2 ${viewMode === 'ranking' ? 'bg-white/10 text-white' : 'text-slate-500'}`}><BarChart size={16}/> Ranking General</button>
                            <button onClick={() => setViewMode('history')} className={`flex-1 py-3 text-center font-bold uppercase text-xs tracking-wider flex items-center justify-center gap-2 ${viewMode === 'history' ? 'bg-white/10 text-white' : 'text-slate-500'}`}><History size={16}/> Últimos Títulos</button>
                        </div>
                        <div className="flex-1 p-4 overflow-y-auto no-scrollbar">
                            {viewMode === 'history' ? (
                                <div className="space-y-3">
                                    {honors.map(h => (
                                        <div key={h.id} className={`p-3 rounded-xl border flex items-center gap-3 relative group transition-all ${h.position === 'runner-up' ? 'bg-slate-800/50 border-white/5 grayscale-[0.5]' : 'bg-gradient-to-r from-slate-900 to-slate-800 border-white/10 hover:border-yellow-500/30'}`}>
                                            <div className="w-10 h-10 bg-white/5 rounded-full flex items-center justify-center border border-white/10 shrink-0">{h.logo && <img src={h.logo} className="w-8 h-8 object-contain"/>}</div>
                                            <div className="flex-1">
                                                <div className={`font-bold text-[10px] uppercase tracking-wider ${h.position === 'runner-up' ? 'text-slate-400' : 'text-yellow-400'}`}>{h.title}</div>
                                                <div className="text-white font-bold text-sm leading-tight">{h.brand} <span className="text-slate-400 font-normal text-xs">{h.model}</span></div>
                                            </div>
                                            <button onClick={(e) => deleteHonor(e, h.id)} className="p-2 text-slate-600 hover:text-red-400 relative z-50"><X size={16}/></button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    <div className="grid grid-cols-12 text-[10px] text-slate-500 uppercase font-bold px-4 mb-2">
                                        <div className="col-span-1">Pos</div>
                                        <div className="col-span-7">Escudería</div>
                                        <div className="col-span-2 text-center text-yellow-500">Copas</div>
                                        <div className="col-span-2 text-center">Subs</div>
                                    </div>
                                    {rankingData.map((data, idx) => (
                                        <div key={idx} onClick={() => setSelectedCarHistory(data)} className="grid grid-cols-12 items-center p-3 bg-white/5 rounded-xl border border-white/5 hover:bg-white/10 cursor-pointer transition-colors group">
                                            <div className="col-span-1"><div className={`w-6 h-6 flex items-center justify-center font-black rounded text-xs ${idx === 0 ? 'bg-yellow-500 text-black' : idx === 1 ? 'bg-slate-300 text-black' : idx === 2 ? 'bg-orange-700 text-white' : 'text-slate-500'}`}>{idx + 1}</div></div>
                                            <div className="col-span-7 flex items-center gap-3">
                                                <div className="w-8 h-8 bg-white/5 rounded-full flex items-center justify-center border border-white/10 shrink-0">{data.car.logo && <img src={data.car.logo} className="w-5 h-5 object-contain"/>}</div>
                                                <div><div className={`text-white font-black text-sm md:text-base leading-none ${headerFontClass}`}>{data.car.brand}</div><div className="text-xs text-blue-300 hidden md:block">{data.car.model}</div></div>
                                            </div>
                                            <div className="col-span-2 text-center"><div className="text-xl font-black text-yellow-500">{data.champions}</div></div>
                                            <div className="col-span-2 text-center"><div className="text-lg font-bold text-slate-500 group-hover:text-white transition-colors">{data.runnerUps}</div></div>
                                        </div>
                                    ))}
                                    {rankingData.length === 0 && <div className="text-center text-slate-500 py-10 italic">Nadie ha ganado copas aún.</div>}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 5. DUELO CALLEJERO
        const StreetCounter = ({ cars }) => {
            const [session, setSession] = useState({ active: false, winner: null });
            const [contestants, setContestants] = useState([]);
            const [editingNames, setEditingNames] = useState(false);
            const showToast = useToast();

            useEffect(() => {
                const unsubscribe = db.collection('street_race').doc('current').onSnapshot(doc => {
                    if (doc.exists) { const data = doc.data(); setSession(data.session); setContestants(data.contestants); } 
                    else { db.collection('street_race').doc('current').set({ session: { active: false, winner: null }, contestants: [ { id: 1, name: 'Auto A', count: 0, color: '#3b82f6', logo: null }, { id: 2, name: 'Auto B', count: 0, color: '#dc2626', logo: null } ] }); }
                });
                return () => unsubscribe();
            }, []);

            const updateFirestore = (newContestants, newSession) => db.collection('street_race').doc('current').update({ contestants: newContestants, session: newSession || session });
            const toggleSession = () => {
                let newSession; let newContestants = [...contestants];
                if (session.active) {
                    const winner = contestants[0].count > contestants[1].count ? contestants[0] : contestants[1].count > contestants[0].count ? contestants[1] : { name: 'Empate' };
                    newSession = { active: false, winner };
                } else { newContestants = contestants.map(c => ({...c, count: 0})); newSession = { active: true, winner: null }; }
                updateFirestore(newContestants, newSession);
            };
            const increment = (idx) => { if (!session.active) return; const newC = [...contestants]; newC[idx].count++; updateFirestore(newC, null); };
            const updateName = (idx, val) => {
                const newC = [...contestants]; newC[idx].name = val;
                const foundCar = cars.find(c => c.brand.toLowerCase().includes(val.toLowerCase()) || c.model.toLowerCase().includes(val.toLowerCase()));
                if (foundCar) { newC[idx].color = foundCar.color; newC[idx].logo = foundCar.logo; } 
                else { newC[idx].color = idx === 0 ? '#3b82f6' : '#dc2626'; newC[idx].logo = null; }
                updateFirestore(newC, null);
            };

            return (
                <div className="w-full h-full flex flex-col items-center justify-start md:justify-center p-4 md:p-8 pt-10 md:pt-0 pb-24 overflow-y-auto">
                    <div className="bg-slate-900/80 backdrop-blur-xl border border-white/20 p-6 md:p-8 rounded-3xl shadow-2xl max-w-4xl w-full text-center">
                        <div className="mb-8"><h2 className={`text-2xl md:text-3xl text-white flex justify-center items-center gap-2 ${headerFontClass}`}><Users className="text-blue-500" /> Duelo Callejero</h2></div>
                        <div className="flex flex-col md:flex-row gap-6 items-center justify-center mb-10">
                            {contestants.map((contestant, idx) => (
                            <div key={idx} className="flex-1 w-full group">
                                <div className="h-10 flex items-center justify-center mb-2">{editingNames && !session.active ? ( <input value={contestant.name} onChange={e => updateName(idx, e.target.value)} className="bg-slate-800 text-white text-center p-2 rounded w-full border border-blue-500/50"/> ) : ( <h3 className={`text-2xl md:text-3xl text-white ${headerFontClass} truncate max-w-[200px]`}>{contestant.name}</h3> )}</div>
                                <button onClick={() => increment(idx)} disabled={!session.active} className={`w-full h-40 md:h-56 rounded-3xl flex items-center justify-center text-7xl md:text-9xl font-black transition-all transform duration-100 relative overflow-hidden border-4 ${session.active ? 'active:scale-95' : 'opacity-50 grayscale'}`} style={{ background: getCarGradient(contestant.color), borderColor: `${contestant.color}80`, color: 'white' }}>{contestant.logo && ( <div className="absolute inset-0 opacity-20 bg-no-repeat bg-center bg-contain" style={{backgroundImage: `url(${contestant.logo})`}}></div> )}<span className="relative z-10 drop-shadow-2xl">{contestant.count}</span></button>
                            </div>
                            ))}
                        </div>
                        {session.winner && !session.active && ( <div className="mb-6 p-4 bg-yellow-900/40 border border-yellow-500/50 rounded-xl animate-bounce-in"><div className={`text-3xl text-white ${headerFontClass}`}>Ganador: {session.winner.name}</div></div> )}
                        <div className="flex flex-col md:flex-row justify-center gap-4">
                            <button onClick={toggleSession} className={`px-8 py-4 rounded-xl font-bold text-lg w-full md:w-auto ${session.active ? 'bg-red-900/80 text-white border border-red-500' : 'bg-blue-600 text-white'}`}>{session.active ? 'FINALIZAR' : 'INICIAR CONTEO'}</button>
                            {!session.active && ( <button onClick={() => setEditingNames(!editingNames)} className="p-4 bg-slate-800 text-white border border-slate-700 rounded-xl flex justify-center"><Edit3 /></button> )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP ROOT ---
        const MoonRacers = () => {
            const [activeTab, setActiveTab] = useState('chrono'); 
            const [cars, setCars] = useState([]);
            const [loadingCars, setLoadingCars] = useState(true);

            useEffect(() => {
                const unsubscribe = db.collection('cars').onSnapshot(snap => {
                    setCars(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoadingCars(false);
                });
                return () => unsubscribe();
            }, []);

            return (
                <ToastProvider>
                    <ModalProvider>
                        <div className="w-full mobile-height bg-slate-950 font-sans text-slate-200 overflow-hidden flex flex-col">
                            <div className="fixed inset-0 bg-gradient-to-br from-slate-950 via-[#0f172a] to-[#020617] z-0 pointer-events-none"></div>
                            
                            {/* Navbar: Scroll Horizontal en móvil */}
                            <nav className="relative z-50 h-16 md:h-24 bg-white/5 backdrop-blur-xl border-b border-white/5 flex items-center justify-between px-4 md:px-8 shadow-2xl shrink-0">
                                <div className="flex items-center gap-3 shrink-0 mr-4">
                                    <div className="w-8 h-8 md:w-10 md:h-10 bg-blue-600 rounded-lg flex items-center justify-center transform -rotate-3"><CarIcon className="text-white w-5 h-5 md:w-6 md:h-6" /></div>
                                    <h1 className={`text-xl md:text-3xl text-white ${headerFontClass} hidden xs:block`}>MOON<span className="text-blue-500">RACERS</span></h1>
                                </div>
                                <div className="flex bg-black/20 p-1 rounded-xl border border-white/5 backdrop-blur-md overflow-x-auto no-scrollbar max-w-[70vw] md:max-w-none">
                                {[ { id: 'chrono', label: 'Torneo', icon: TimerIcon }, { id: 'copa', label: 'Copa', icon: Trophy }, { id: 'palmares', label: 'Palmarés', icon: Medal }, { id: 'garage', label: 'Garaje', icon: Target }, { id: 'street', label: 'Calle', icon: Users }, ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-3 md:px-5 py-2 rounded-lg text-xs md:text-sm font-bold transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400'}`}>
                                    <tab.icon size={16} /><span className={activeTab === tab.id ? 'block' : 'hidden md:block'}>{tab.label}</span>
                                    </button>
                                ))}
                                </div>
                            </nav>
                            
                            <main className="relative z-10 flex-1 overflow-hidden">
                                {activeTab === 'chrono' && <TimeTrial cars={cars} />}
                                {activeTab === 'copa' && <Tournament cars={cars} onSaveToPalmares={(c) => setActiveTab('palmares')} />}
                                {activeTab === 'palmares' && <Palmares cars={cars} />}
                                {activeTab === 'garage' && <Garage cars={cars} loading={loadingCars} />}
                                {activeTab === 'street' && <StreetCounter cars={cars} />}
                            </main>
                        </div>
                    </ModalProvider>
                </ToastProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MoonRacers />);
    </script>
</body>
</html>
